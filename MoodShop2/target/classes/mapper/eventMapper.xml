<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.moodshop.kokone.dao.EventDAO">

	<!-- 이벤트 전체 출력용 -->
	<select id="getAllEventDetail" resultType="EventVO">
		SELECT * FROM
		EVENT_TBL
		ORDER BY EVENT_ID
	</select>

	<!-- 종료된 이벤트 와 구분하는 용 MAIN=진행중 / SITE=종료 -->
	<select id="getMainEventDetails" resultType="EventVO">
		SELECT *
		FROM
		EVENT_TBL
		WHERE EVENT_TYPE = 'MAIN'
		ORDER BY EVENT_START_DATE
	</select>

	<!-- eventMain_serve.jsp 카테고리 구분 prefix (예: 진행 중인 이벤트 > ...) -->
	<select id="selectEventDetailsByCategoryPrefix"
		parameterType="String" resultType="EventVO">
		SELECT *
		FROM EVENT_TBL
		WHERE
		EVENT_CATEGORY LIKE '%' || #{prefix} || '%'
		AND
		EVENT_TYPE = 'MAIN'
	</select>

	<!-- ✅ eventClick.jsp - 진행중 -->
	<select id="selectOngoingEventDetails" resultType="EventVO">
		SELECT *
		FROM
		EVENT_TBL
		WHERE EVENT_END_DATE >= SYSDATE

	</select>

	<!-- ✅ eventClick.jsp - 종료됨 -->
	<select id="selectEndedEventDetails" resultType="EventVO">
		SELECT *
		FROM
		EVENT_TBL
		WHERE EVENT_TYPE = 'SITE'
		AND SYSDATE > EVENT_END_DATE

	</select>
	<!-- eventClick_serve.jsp 페이지를 불러올 때 아이디로 구분됨 -->
	<select id="selectEventById" parameterType="string"
		resultType="EventVO">
		SELECT *
		FROM EVENT_TBL
		WHERE EVENT_ID = #{event_id}
	</select>

	<!-- eventClick.jsp 내 검색 기능 -->
	<select id="selectEventDetailsByNameLike" resultType="EventVO">
		SELECT *
		FROM EVENT_TBL
		WHERE EVENT_NAME LIKE '%' || #{keyword} || '%'
		OR
		EVENT_TITLE LIKE '%' || #{keyword} || '%'
		OR 
		EVENT_CATEGORY LIKE '%' || #{keyword} || '%'
		OR 
		EVENT_DESCRIPTION LIKE '%' || #{keyword} || '%'
		ORDER BY EVENT_START_DATE DESC
	</select>

	<!-- 여기 부터 관리자용  -->
	
	<insert id="insertEvent" parameterType="com.moodshop.kokone.vo.EventVO">
        <!-- 올바른 예 -->
		INSERT INTO EVENT_TBL (EVENT_ID, EVENT_NAME, 
							   EVENT_TYPE, EVENT_TITLE, 
							   EVENT_DESCRIPTION, EVENT_START_DATE, 
							   EVENT_END_DATE, EVENT_CATEGORY, 
							   EVENT_IMAGE_SOURCE, EVENT_SUB_IMAGE_SOURCE)
		VALUES (#{event_id}, #{event_name}, 
				#{event_type}, #{event_title}, 
				#{event_description}, #{event_start_date}, 
				#{event_end_date}, #{event_category}, 
				#{event_image_source}, #{event_sub_image_source, jdbcType=VARCHAR})
	<!-- jdbcType=VARCHAR 를 사용한 이유 : MyBatis가 null 값을 넘길 경우 기본 타입을 못 잡음 -->
    </insert>

    <update id="updateEvent" parameterType="com.moodshop.kokone.vo.EventVO">
        UPDATE EVENT_TBL
        SET EVENT_NAME = #{event_name},
            EVENT_TYPE = #{event_type},
            EVENT_TITLE = #{event_title},
            EVENT_DESCRIPTION = #{event_description},
            EVENT_START_DATE = #{event_start_date},
            EVENT_END_DATE = #{event_end_date},
            EVENT_CATEGORY = #{event_category},
            EVENT_IMAGE_SOURCE = #{event_image_source},
            EVENT_SUB_IMAGE_SOURCE = #{event_sub_image_source}
        WHERE EVENT_ID = #{event_id}
    </update>
    
    <update id="updateEventColumn" parameterType="map">
   		UPDATE EVENT_TBL
    	SET ${column} = 
    	<choose>
        	<when test="column == 'event_start_date' or column == 'event_end_date'">
            	TO_DATE(#{newValue}, 'YYYY-MM-DD')
        	</when>
        	<otherwise>
            	#{newValue}
        	</otherwise>
    	</choose>
    	WHERE EVENT_ID = #{eventId}
	</update>

    

    <delete id="deleteEvent" parameterType="String">
        DELETE FROM EVENT_TBL WHERE EVENT_ID = #{event_id}
    </delete>

    <select id="getEventList" resultType="EventVO">
        SELECT * FROM EVENT_TBL ORDER BY EVENT_START_DATE DESC
    </select>
</mapper>
