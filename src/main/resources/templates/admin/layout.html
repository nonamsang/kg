<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko" th:fragment="layout(content, scripts)">

<head>
	<meta charset="UTF-8" />
	<title th:text="${title} ?: '관리자'">관리자</title>
	<meta name="viewport" content="width=device-width, initial-scale=1" />

	<link rel="stylesheet" th:href="@{/css/admin.css(v=${#dates.createNow().time})}" />

	<!-- CSRF -->
	<!--<meta name="_csrf" th:content="${_csrf.token}">
	<meta name="_csrf_header" th:content="${_csrf.headerName}">-->

	<meta name="_csrf" th:if="${_csrf != null}" th:content="${_csrf.token}">
	<meta name="_csrf_header" th:if="${_csrf != null}" th:content="${_csrf.headerName}">


	<!-- Axios -->
	<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
	<script>
		// 세션 쿠키 포함
		axios.defaults.withCredentials = true;

		// 모든 요청에 CSRF 자동 주입
		axios.interceptors.request.use((config) => {
			const tokenEl = document.querySelector('meta[name="_csrf"]');
			const headerEl = document.querySelector('meta[name="_csrf_header"]');
			if (tokenEl && headerEl) {
				config.headers[headerEl.content] = tokenEl.content; // 예: X-CSRF-TOKEN
			}
			return config;
		});
	</script>
</head>

<body class="admin light">
	<header class="topbar">
		<div class="topbar-inner">
			<a th:href="@{/admin/members}" class="logo">
				<img th:src="@{/image/brand-mark.svg}" alt="logo" class="logo-mark">
				<span class="logo-name">관리자</span>
			</a>
			<h1 class="page-title" th:text="${title} ?: '관리자'">관리자</h1>
			<div class="top-actions">
				<!--<form th:action="@{/admin/logout}" method="post">
					<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
					<button type="submit" class="btn-outlined">로그아웃</button>
				</form>-->

				<form th:action="@{/admin/logout}" method="post">
					<input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}"
						th:value="${_csrf.token}">
					<button type="submit" class="btn-outlined">로그아웃</button>
				</form>

			</div>
		</div>
	</header>

	<aside class="sidebar">
		<nav class="nav">
			<a th:href="@{/admin/members}" th:classappend="${page=='members'} ? ' active'">회원관리</a>
			<a th:href="@{/admin/posts}" th:classappend="${page=='posts'}   ? ' active'">게시판관리</a>
			<a th:href="@{/admin/chat?roomId=1}" th:classappend="${page=='chat'}    ? ' active'">채팅</a>
			<a th:href="@{/admin/stats}" th:classappend="${page=='stats'}   ? ' active'">통계</a>
			<a th:href="@{/admin/product}" th:classappend="${page=='stats'}   ? ' active'">상품</a>
			<a th:href="@{/admin/product/product_update}" th:classappend="${page=='stats'}   ? ' active'">상품 관리</a>

			<!-- 개발/테스트용: 세션 전환 메뉴 -->
			<hr>
			<a href="#" data-id="1" class="set-user">아이디1로</a>
			<a href="#" data-id="2" class="set-user">아이디2로</a>
			<a href="#" data-id="3" class="set-user">아이디3로</a>
			<a href="#" data-id="4" class="set-user">아이디4로</a>
			<a href="#" data-id="5" class="set-user">아이디5로</a>
		</nav>
	</aside>

	<main class="content">
		<div class="container">
			<th:block th:insert="${content}"></th:block>
		</div>
	</main>
	<th:block th:insert="${scripts}"></th:block>
	<!-- set-user JS -->
	<script>

		const csrfMeta = document.querySelector('meta[name="_csrf"]');
		const csrfHeader = document.querySelector('meta[name="_csrf_header"]');

		document.querySelectorAll('.set-user').forEach(link => {
			link.addEventListener('click', function (e) {
				e.preventDefault();
				const userId = this.dataset.id;

				const headers = {'Content-Type': 'application/x-www-form-urlencoded'};
				if (csrfMeta && csrfHeader) {
					headers[csrfHeader.content] = csrfMeta.content;
				}

				fetch('/set-user', {
					method: 'POST',
					headers,
					//: {
					//},
					body: `id=${userId}`
				})
					.then(res => res.text())
					.then(msg => {
						console.log("세션 변경 완료:", msg);
						// 필요 시 화면 새로고침
						// location.reload();
					});
			});
		});
	</script>
</body>

</html>