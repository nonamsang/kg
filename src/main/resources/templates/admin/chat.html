<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<link rel="stylesheet" th:href="@{/css/admin-chat.css}" />

<body th:replace="~{admin/layout :: layout(~{::section}, ~{::#page-scripts})}">

	<section>
		<!-- <h3>웹소켓 채팅 데모</h3>
		<div>
			Room: <input id="roomId" value="room1"> 
			Nick: <input id="nick" value="user1">
			<button onclick="connect()">Connect</button>
			<button onclick="disconnect()">Disconnect</button>
		</div>
		
		<div style="margin-top: 8px">
			<input id="msg" placeholder="메시지 입력" style="width: 80%">
			<button onclick="send()">Send</button>
		</div>
  <!-- 좌측 채팅방 목록 -->
		<div class="chatroom_container">
			<div th:each="c : ${chatroom}" class="chatroom-card">
				<div class="chatroom-info">
					<div class="chatroom-name" th:text="${c.name}"></div>
					<div class="chatroom-lastmsg" th:text="${c.last_Message}"></div>
					<div class="chatroom-other" th:text="${c.other_User_Nickname}"></div>
				</div>
			</div>
		</div>

		<!-- 우측 채팅영역 -->
		<div class="chat_area">
			<div class="chat_container">
				<div class="chat_each_container" th:each="chat : ${chat}">
					<div class="msg">
						<img th:src="@{${profile_Path}}" alt="profile" class="msg-profile">
						<div class="msg-bubble" th:text="${chat.content}"></div>
					</div>
				</div>
			</div>

			<!-- 입력창 -->
			<div class="chat-input">
				<input id="msg" type="text" placeholder="메시지를 입력하세요" />
				<button onclick="send()">보내기</button>
				<button onclick="connect()">커넥트</button>
			</div>
		</div>

		<script th:inline="javascript">
			let stomp, sub;
			let currentRoomId = 1;   // 지금 보고 있는 방 ID를 여기로.
			let myId = [[${session.user_Id}]]; //빨간줄 무시
			let reconnecting = false;

			function connect() {
				const sock = new SockJS('/ws-chat');
				stomp = Stomp.over(sock);

				// ① STOMP 디버그 출력: SEND/SUBSCRIBE/MESSAGE 프레임을 콘솔에 다 보여줌
				stomp.debug = (str) => console.log('[STOMP]', str);

				stomp.connect({}, () => {
					console.log('✅ STOMP connected?', stomp.connected);

					// ② 구독 설정 (서버가 convertAndSend("/topic/rooms/"+roomId) 로 보내는지 꼭 확인!)
					const dest = `/topic/rooms/${currentRoomId}`;
					console.log('🔔 SUBSCRIBE to', dest);
					if (sub) sub.unsubscribe();
					sub = stomp.subscribe(dest, (frame) => {
						console.log('📥 RECEIVED FRAME', frame);            // 헤더/바디 다 보임
						try {
							const m = JSON.parse(frame.body);
							console.log('📩 PARSED MSG', m);
							appendMessage(m);                                 // 화면에 추가
						} catch (e) {
							console.error('JSON parse error', e, frame.body);
						}
					});

				}, (err) => {
					console.error('❌ STOMP connect error', err);
				});

				sock.onclose = scheduleReconnect;
			}

			function scheduleReconnect() {
				if (reconnecting) return;
				reconnecting = true;
				console.log('reconnect 시도중');
				setTimeout(() => {reconnecting = false; connect();}, 3000);
			}

			function send() {
				const input = document.getElementById('msg');
				const text = input.value.trim();
				if (!text) return;

				if (!stomp || !stomp.connected) {
					return console.warn('⚠️ 아직 연결 안됨. connect() 먼저 실행하세요.');
				}
				if (!currentRoomId) {
					return console.warn('⚠️ currentRoomId 미설정');
				}

				const payload = {
					type: 'SEND',
					chat_Room_Id: currentRoomId,   // 서버 VO 필드명과 100% 동일해야 함
					sender: myId,                  // 서버 VO가 받는 필드명과 동일 (sender? senderId?)
					content: text
				};

				console.log('➡️ SEND payload', payload);
				stomp.send('/app/chat.send', {}, JSON.stringify(payload));
				input.value = '';
			}

			function appendMessage(m) {
				const wrap = document.querySelector('.chat_container');
				if (!wrap) {
					console.warn('chat_container 없음');
					return;
				}
				const msgDiv = document.createElement('div');
				msgDiv.className = 'msg';
				if (String(m.sender) === String(myId)) msgDiv.classList.add('me'); // 타입 캐스팅 안전하게

				const bubble = document.createElement('div');
				bubble.className = 'msg-bubble';
				bubble.textContent = m.content ?? ''; // textContent로 XSS 안전

				msgDiv.appendChild(bubble);
				wrap.appendChild(msgDiv);

				// 스크롤 다운
				wrap.scrollTop = wrap.scrollHeight;
			}
		</script>
		<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
		<!-- 그 다음 STOMP -->
		<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
		<!-- 마지막에 당신의 chat.js (connect(), send() 정의된 파일) -->
	</section>
</body>

</html>