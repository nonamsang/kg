<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<link rel="stylesheet" th:href="@{/css/admin-chat.css}" />

<body th:replace="~{admin/layout :: layout(~{::section}, ~{::#page-scripts})}">

	<section>
		<!-- <h3>웹소켓 채팅 데모</h3>
		<div>
			Room: <input id="roomId" value="room1"> 
			Nick: <input id="nick" value="user1">
			<button onclick="connect()">Connect</button>
			<button onclick="disconnect()">Disconnect</button>
		</div>
		
		<div style="margin-top: 8px">
			<input id="msg" placeholder="메시지 입력" style="width: 80%">
			<button onclick="send()">Send</button>
		</div>
  <!-- 좌측 채팅방 목록 -->
		<div class="chatroom_container">
			<div th:each="c : ${chatroom}" class="chatroom-card">
				<div class="chatroom-info">
					<div class="chatroom-name" th:text="${c.name}"></div>
					<div class="chatroom-lastmsg" th:text="${c.last_Message}"></div>
					<div class="chatroom-other" th:text="${c.other_User_Nickname}"></div>
				</div>
			</div>
		</div>

		<!-- 우측 채팅영역 -->
		<div class="chat_area">
  <div class="chat_container">

    <!-- ✅ 단일 리스트 컨테이너 -->
    <div id="msgs" class="chat_each_container">
      <!-- 과거 메시지 렌더링 -->
      <div class="msg"
           th:each="chat : ${chat}"
           th:with="isMe=${session.user_Id} == ${chat.sender}"
           th:classappend="${isMe} ? ' me' : null">

        <img th:if="${!isMe}"
             th:src="@{'/image/profile/' + ${otheruser.other_User_Profile}}"
             alt="profile" class="msg-profile">

        <div class="msg-body">
          <div class="meta" th:if="${!isMe}"
               th:text="${otheruser.other_User_Name}"></div>
          <div class="msg-bubble" th:text="${chat.content}"></div>
        </div>
      </div>
    </div>

  </div>
		

			<!-- 입력창 -->
			<div class="chat-input">
				<input id="msg" type="text" placeholder="메시지를 입력하세요" />
				<button onclick="send()">보내기</button>
				<button onclick="connect()">커넥트</button>
			</div>
		</div>

		<script th:inline="javascript">
			let stomp, sub;
			let currentRoomId = 1;   // 지금 보고 있는 방 ID를 여기로.
			
			let reconnecting = false;
			// 내 유저 ID (숫자형으로 주입)
			const myId = /*[[${session.user_Id}]]*/ 0;

			// 현재 방의 상대 유저 프로필/닉네임 (이 방은 1:1이라고 가정)
			const otherName = /*[[${#strings.escapeJavaScript(otheruser.other_User_Name)}]]*/ '';
			const otherProfileUrl = /*[[@{'/image/profile/' + ${otheruser.other_User_Profile}}]]*/ '';
			document.querySelector('.chat_each_container')
			function connect() {
				const sock = new SockJS('/ws-chat');
				stomp = Stomp.over(sock);

				// ① STOMP 디버그 출력: SEND/SUBSCRIBE/MESSAGE 프레임을 콘솔에 다 보여줌
				stomp.debug = (str) => console.log('[STOMP]', str);

				stomp.connect({}, () => {
					console.log('✅ STOMP connected?', stomp.connected);

					// ② 구독 설정 (서버가 convertAndSend("/topic/rooms/"+roomId) 로 보내는지 꼭 확인!)
					const dest = `/topic/rooms/${currentRoomId}`;
					console.log('🔔 SUBSCRIBE to', dest);
					if (sub) sub.unsubscribe();
					sub = stomp.subscribe(dest, (frame) => {
						console.log('📥 RECEIVED FRAME', frame);            // 헤더/바디 다 보임
						try {
							const m = JSON.parse(frame.body);
							console.log('📩 PARSED MSG', m);
							appendMessage(m);                                 // 화면에 추가
						} catch (e) {
							console.error('JSON parse error', e, frame.body);
						}
					});

				}, (err) => {
					console.error('❌ STOMP connect error', err);
				});

				sock.onclose = scheduleReconnect;
			}

			function scheduleReconnect() {
				if (reconnecting) return;
				reconnecting = true;
				console.log('reconnect 시도중');
				setTimeout(() => {reconnecting = false; connect();}, 3000);
			}

			function send() {
				const input = document.getElementById('msg');
				const text = input.value.trim();
				if (!text) return;

				if (!stomp || !stomp.connected) {
					return console.warn('⚠️ 아직 연결 안됨. connect() 먼저 실행하세요.');
				}
				if (!currentRoomId) {
					return console.warn('⚠️ currentRoomId 미설정');
				}

				const payload = {
					type: 'SEND',
					chat_Room_Id: currentRoomId,   // 서버 VO 필드명과 100% 동일해야 함
					sender: myId,                  // 서버 VO가 받는 필드명과 동일 (sender? senderId?)
					content: text
				};

				console.log('➡️ SEND payload', payload);
				stomp.send('/app/chat.send', {}, JSON.stringify(payload));
				input.value = '';
			}

			function appendMessage(m) {
				  const list = document.querySelector('.chat_each_container'); // ✅ 여기!
				  if (!list) return console.warn('chat_each_container 없음');

				  const isMe = Number(m.sender) === Number(myId);

				  const row = document.createElement('div');
				  row.className = 'msg' + (isMe ? ' me' : '');

				  // 상대 메시지면 프로필 이미지 추가
				  if (!isMe) {
				    const img = document.createElement('img');
				    img.className = 'msg-profile';
				    img.alt = 'profile';
				    img.src = otherProfileUrl;
				    row.appendChild(img);
				  }

				  // 텍스트 영역 (닉네임 + 버블)
				  const body = document.createElement('div');
				  body.className = 'msg-body';

				  // 상대 메시지면 닉네임(회색 작은 글씨)
				  if (!isMe) {
				    const meta = document.createElement('div');
				    meta.className = 'meta';
				    meta.textContent = otherName;
				    body.appendChild(meta);
				  }

				  // 실제 메시지 버블
				  const bubble = document.createElement('div');
				  bubble.className = 'msg-bubble';
				  bubble.textContent = m.content ?? '';
				  body.appendChild(bubble);

				  row.appendChild(body);
				  list.appendChild(row);

				  // 스크롤 하단 고정
				  list.scrollTop = list.scrollHeight;
				}
		</script>
		
		<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
		
		<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
		
		<th:block id="page-scripts"></th:block>
	</section>
</body>

</html>