<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<link rel="stylesheet" th:href="@{/css/admin-chat.css}" />

<body th:replace="~{admin/layout :: layout(~{::section}, ~{::#page-scripts})}">

	<section>

		<!-- ì¢Œì¸¡ ì±„íŒ…ë°© ëª©ë¡ -->
		<div class="chatroom_container">
			<a th:each="c : ${chatroom}" class="chatroom-card"
				th:onclick="|window.roomId = ${c.id}; window.loadRoom(); return false;|">
				<div class="chatroom-info">
					<div class="chatroom-name" th:text="${c.name}"></div>
					<div class="chatroom-lastmsg" th:text="${c.last_Message}"></div>
					<div class="chatroom-other" th:text="${c.other_User_Nickname}"></div>
				</div>
			</a>
		</div>

		<!-- ìš°ì¸¡ ì±„íŒ…ì˜ì—­ -->
		<div class="chat_area">
			<div class="chat_container">

				<!-- âœ… ë‹¨ì¼ ë¦¬ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ -->
				<div id="msgs" class="chat_each_container">
					<!-- ê³¼ê±° ë©”ì‹œì§€ ë Œë”ë§ -->
					<div class="msg" th:each="chat : ${chat}" th:with="isMe=${session.user_Id} == ${chat.sender}"
						th:classappend="${isMe} ? ' me' : null">


						<img th:if="${!isMe}" th:src="@{'/image/profile/' + ${otheruser.other_User_Profile}}"
							alt="profile" class="msg-profile">

						<div class="msg-body">
							<div class="meta" th:if="${!isMe}" th:text="${otheruser.other_User_Name}"></div>
							<div class="msg-bubble" th:text="${chat.content}"></div>
						</div>
					</div>
				</div>
			</div>


			<!-- ì…ë ¥ì°½ -->
			<div class="chat-input">
				<input id="msg" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
				<button onclick="send()">ë³´ë‚´ê¸°</button>
			</div>
		</div>

		<script th:inline="javascript">
			// ì „ì—­ ìƒíƒœ (ìƒëŒ€ ì •ë³´ & ë‚´ ì•„ì´ë””)
			window.roomId = null;
			let MY_ID = /*[[${session.user_Id}]]*/ 0; // í˜ì´ì§€ ìµœì´ˆ ì§„ì… ì‹œ ì„¸ì…˜ê°’
			let OTHER_NAME = 'ìƒëŒ€';
			let OTHER_PROFILE_URL = '/image/profile/default.png';

			const chatArea = document.querySelector('.chat_area');
			const msgs = document.getElementById('msgs');

			// 1) ì„œë²„ì—ì„œ JSONìœ¼ë¡œ data ê°€ì ¸ì˜¤ê¸°, ì»¤ë„¥íŠ¸
			async function loadRoom() {

				connect();

				const res = await fetch(`/chat/data?roomId=${roomId}`/*ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ jsonìœ¼ë¡œ ê°’ ë°›ì•„ì˜¤ê¸°*/, {
					headers: {'Accept': 'application/json'} // jsonìœ¼ë¡œ ê°’ì„ ë°›ì•„ì˜¤ê²Ÿë‹¤ëŠ” ì•½ì†
				});

				const data = await res.json(); //controllerì—ì„œ jsonìœ¼ë¡œ ë„˜ì–´ì˜¨ ê°’ íŒŒì‹±

				renderChat(data); // renderchat í•¨ìˆ˜ì— dataë¥¼ ë„£ìŒ 
			}

			// 2) ê¸°ë³¸ ì •ë³´ ë„£ê³  ì±„íŒ… ë¶ˆëŸ¬ì˜¤ê¸°
			function renderChat(data) {

				MY_ID = data.myId; // dataì—ì„œ ë°›ì•„ì˜¨ ê°’ì„ MY_IDì— ë„£ìŒ
				OTHER_NAME = data?.otheruser?.other_User_Name || 'ìƒëŒ€'; //other_User_Name ê°€ì ¸ì˜¤ê³  ì—†ìœ¼ë©´ ë„ê°€ë“œ
				OTHER_PROFILE_URL = data?.otheruser?.other_User_Profile
					? `/image/profile/${data.otheruser.other_User_Profile}` : '/image/profile/default.png';

				msgs.innerHTML = ''; // ê¸°ì¡´ ë©”ì„¸ì§€ ì‚­ì œ

				(data.chat || []).forEach(m => appendMessage(m, MY_ID));
				// dataì—ì„œ ê°€ì ¸ì˜¨ chat ë§Œí¼ ê¸°ì¡´ chat ë§Œë“œëŠ” ëª…ë ¹ ë°˜ë³µ

				msgs.scrollTop = msgs.scrollHeight;
				// ì±— ìƒì„±ë˜ë©´ ìŠ¤í¬ë¡¤ ì˜¬ë¼ê°€ë‹ˆ ì „ë¶€ ìƒì„± í›„ì—” ì œì¼ ë°‘ìœ¼ë¡œ ë‚´ë ¤ì£¼ê¸°
			}

			// 3) chatë©”ì„¸ì§€ í•œì¤„ ë§Œë“¤ê¸° (ê³¼ê±° ë©”ì‹œì§€/ ì›¹ì†Œì¼“ ìˆ˜ì‹  ê³µìš©)
			function appendMessage(m, myIdFromData = MY_ID) {
				const isMe = Number(m.sender) === Number(myIdFromData);

				const row = document.createElement('div');
				row.className = 'msg' + (isMe ? ' me' : '');
				//ë‚´ ë©”ì„¸ì§€ë¼ë©´ class = .msg.me ìƒëŒ€ë¼ë©´ .msg

				if (!isMe) { // ìƒëŒ€ ë©”ì„¸ì§€ë¼ë©´ í”„ë¡œí•„ ì‚¬ì§„ ì¶”ê°€
					const img = document.createElement('img');
					img.className = 'msg-profile';
					img.alt = 'profile';
					img.src = OTHER_PROFILE_URL;
					row.appendChild(img);
				}

				const body = document.createElement('div');
				body.className = 'msg-body';

				if (!isMe) { // ìƒëŒ€ ë©”ì„¸ì§€ë¼ë©´ ë‹‰ë„¤ì„ í‘œê¸°
					const meta = document.createElement('div');
					meta.className = 'meta';
					meta.textContent = OTHER_NAME;
					body.appendChild(meta);
				}

				const bubble = document.createElement('div'); //ë©”ì„¸ì§€ ë§Œë“¤ì–´ì£¼ê¸° (ìƒëŒ€ ë©”ì„¸ì§€, ë‚´ ë©”ì„¸ì§€ ê³µí†µ)
				bubble.className = 'msg-bubble';
				bubble.textContent = m.content ?? '';
				body.appendChild(bubble);

				row.appendChild(body);
				msgs.appendChild(row);
				msgs.scrollTop = msgs.scrollHeight;
			}


			let stomp, sub;
			let reconnecting = false;

			function connect() { //ì±„íŒ…ë°©ì— websorket ì»¤ë„¥íŠ¸
				const sock = new SockJS('/ws-chat'); //websorketconfigì—ì„œ ì—”ë“œí¬ì¸íŠ¸ ê°€ì ¸ì˜¤ê¸°
				stomp = Stomp.over(sock); //stomp í´ë¼ì´ì–¸íŠ¸ë¡œ ê°ì‹¸ê¸°

				stomp.debug = (str) => console.log('[STOMP]', str);

				stomp.connect({}, () => {
					console.log('âœ… STOMP connected?', stomp.connected);


					const dest = `/topic/rooms/${roomId}`; //topic/rooms/${roomId}ì— ì—°ê²°!!
					console.log('ğŸ”” SUBSCRIBE to', dest); //ì—°ê²° ë¡œê·¸ ì°ê¸°
					if (sub) sub.unsubscribe(); // ê°™ì€ ë°©ì´ ì¡´ì¬í•˜ë‹¤ë©´ ìƒˆ ì—°ê²° ë§Œë“¤ì§€ ì•ŠìŒ!
					sub = stomp.subscribe(dest, (frame) => {
						console.log('ğŸ“¥ RECEIVED FRAME', frame);            // í—¤ë”/ë°”ë”” ë‹¤ ë³´ì„
						try {
							const m = JSON.parse(frame.body);
							//connectëœ ë°©ì—ì„œ ë°›ì€ ë©”ì„¸ì§€ë¥¼ mì— ë„£ìŒ!! (ìì‹ ì˜ ë©”ì„¸ì§€ í¬í•¨)
							console.log('ğŸ“© PARSED MSG', m); // ë©”ì„¸ì§€ ë¡œê·¸ ì°ê¸°
							appendMessage(m);  // í™”ë©´ì— ì¶”ê°€
						} catch (e) {
							console.error('JSON parse error', e, frame.body);
						}
					});

				}, (err) => {
					console.error('âŒ STOMP connect error', err);
				});

				sock.onclose = scheduleReconnect;
			}

			function scheduleReconnect() {
				if (reconnecting) return;
				reconnecting = true;
				console.log('reconnect ì‹œë„ì¤‘');
				setTimeout(() => {reconnecting = false; connect();}, 3000);
			}

			function send() {
				console.log("ë£¸ì•„ì´ë””: " + roomId);
				const input = document.getElementById('msg');
				const text = input.value.trim();
				if (!text) return;

				if (!stomp || !stomp.connected) {
					return console.warn('âš ï¸ ì•„ì§ ì—°ê²° ì•ˆë¨. connect() ë¨¼ì € ì‹¤í–‰í•˜ì„¸ìš”.');
				}

				const payload = {
					type: 'SEND',
					chat_Room_Id: roomId,   // ì„œë²„ VO í•„ë“œëª…ê³¼ 100% ë™ì¼í•´ì•¼ í•¨
					sender: MY_ID,
					content: text
				};

				console.log('â¡ï¸ SEND payload', payload);
				stomp.send('/app/chat.send', {}, JSON.stringify(payload));
				input.value = '';
			}

		</script>

		<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>

		<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

		<th:block id="page-scripts"></th:block>
	</section>
</body>

</html>