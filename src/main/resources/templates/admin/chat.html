<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<link rel="stylesheet" th:href="@{/css/admin-chat.css}" />

<body
	th:replace="~{admin/layout :: layout(~{::section}, ~{::#page-scripts})}">

	<section>

		<!-- ì¢Œì¸¡ ì±„íŒ…ë°© ëª©ë¡ -->
		<div class="chatroom_container">
			<a th:each="c : ${chatroom}" class="chatroom-card"
				th:onclick="|window.roomId = ${c.id}; window.loadRoom(); return false;|">
				<div class="chatroom-info">
					<div class="chatroom-name" th:text="${c.name}"></div>
					<div class="chatroom-lastmsg" th:text="${c.last_Message}"></div>
					<div class="chatroom-other" th:text="${c.other_User_Nickname}"></div>
				</div>
			</a>
		</div>

		<!-- ìš°ì¸¡ ì±„íŒ…ì˜ì—­ -->
		<div class="chat_area">
			<div class="chat_container">

				<!-- âœ… ë‹¨ì¼ ë¦¬ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ -->
				<div id="msgs" class="chat_each_container">
					<!-- ê³¼ê±° ë©”ì‹œì§€ ë Œë”ë§ -->
					<div class="msg" th:each="chat : ${chat}"
						th:with="isMe=${session.user_Id} == ${chat.sender}"
						th:classappend="${isMe} ? ' me' : null">
						

						<img th:if="${!isMe}"
							th:src="@{'/image/profile/' + ${otheruser.other_User_Profile}}"
							alt="profile" class="msg-profile">

						<div class="msg-body">
							<div class="meta" th:if="${!isMe}"
								th:text="${otheruser.other_User_Name}"></div>
							<div class="msg-bubble" th:text="${chat.content}"></div>
						</div>
					</div>
				</div>
			</div>


			<!-- ì…ë ¥ì°½ -->
			<div class="chat-input">
				<input id="msg" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
				<button onclick="send()">ë³´ë‚´ê¸°</button>
			</div>
		</div>

		<script th:inline="javascript">
		// ì „ì—­ ìƒíƒœ (ìƒëŒ€ ì •ë³´ & ë‚´ ì•„ì´ë””)
		  window.roomId = null;
		  let MY_ID   = /*[[${session.user_Id}]]*/ 0; // í˜ì´ì§€ ìµœì´ˆ ì§„ì… ì‹œ ì„¸ì…˜ê°’
		  let OTHER_NAME = 'ìƒëŒ€';
		  let OTHER_PROFILE_URL = '/image/profile/default.png';

		  const chatArea = document.querySelector('.chat_area');
		  const msgs = document.getElementById('msgs');

		  // 1) ë°© ì—´ê¸°: ì„œë²„ì—ì„œ JSON ê°€ì ¸ì˜¤ê³  ê·¸ë¦¬ê¸°
		  async function loadRoom() {
			
			connect();
			
		    const res = await fetch(`/admin/chat/data?roomId=${roomId}`, {
		      headers: { 'Accept': 'application/json' }
		    });

		    const data = await res.json();

		    MY_ID = data.myId;
		    
		    renderChat(data);
		  }

		  // 2) ë¦¬ìŠ¤íŠ¸ ì „ì²´ ë Œë” (ê¸°ì¡´ ì§€ìš°ê³  ë‹¤ì‹œ ê·¸ë¦¼)
		  function renderChat(data) {
		    OTHER_NAME = data?.otheruser?.other_User_Name || 'ìƒëŒ€';
		    OTHER_PROFILE_URL = data?.otheruser?.other_User_Profile
		      ? `/image/profile/${data.otheruser.other_User_Profile}`
		      : '/image/profile/default.png';

		    // ê¸°ì¡´ ë©”ì‹œì§€ ì‚­ì œ (ì„œë²„ ë Œë”ì™€ ê²¹ì¹˜ê²Œ ì‹«ìœ¼ë©´ ì´ ì¤„ ì£¼ì„ì²˜ë¦¬)
		    msgs.innerHTML = '';

		    (data.chat || []).forEach(m => appendMessage(m, MY_ID));
		    
		   

		    // ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
		    msgs.scrollTop = msgs.scrollHeight;
		  }

		  // 3) í•œ ì¤„ ì¶”ê°€ (ê³¼ê±° ë©”ì‹œì§€/ì›¹ì†Œì¼“ ìˆ˜ì‹  ê³µìš©)
		  function appendMessage(m, myIdFromData = MY_ID) {
		    const isMe = Number(m.sender) === Number(myIdFromData);

		    const row = document.createElement('div');
		    row.className = 'msg' + (isMe ? ' me' : '');

		    if (!isMe) {
		      const img = document.createElement('img');
		      img.className = 'msg-profile';
		      img.alt = 'profile';
		      img.src = OTHER_PROFILE_URL;
		      row.appendChild(img);
		    }

		    const body = document.createElement('div');
		    body.className = 'msg-body';

		    if (!isMe) {
		      const meta = document.createElement('div');
		      meta.className = 'meta';
		      meta.textContent = OTHER_NAME;
		      body.appendChild(meta);
		    }

		    const bubble = document.createElement('div');
		    bubble.className = 'msg-bubble';
		    bubble.textContent = m.content ?? '';
		    body.appendChild(bubble);

		    row.appendChild(body);
		    msgs.appendChild(row);
		    msgs.scrollTop = msgs.scrollHeight;
		  }
		  

		  let stomp, sub;
		  let reconnecting = false;

		  function connect() {
		  	console.log("ë£¸ì€ :" +roomId);
		  	const sock = new SockJS('/ws-chat');
		  	stomp = Stomp.over(sock);

		  	// â‘  STOMP ë””ë²„ê·¸ ì¶œë ¥: SEND/SUBSCRIBE/MESSAGE í”„ë ˆì„ì„ ì½˜ì†”ì— ë‹¤ ë³´ì—¬ì¤Œ
		  	stomp.debug = (str) => console.log('[STOMP]', str);

		  	stomp.connect({}, () => {
		  		console.log('âœ… STOMP connected?', stomp.connected);

		  		// â‘¡ êµ¬ë… ì„¤ì • (ì„œë²„ê°€ convertAndSend("/topic/rooms/"+roomId) ë¡œ ë³´ë‚´ëŠ”ì§€ ê¼­ í™•ì¸!)
		  		
		  		
		  		const dest = `/topic/rooms/${roomId}`;
		  		console.log('ğŸ”” SUBSCRIBE to', dest);
		  		if (sub) sub.unsubscribe();
		  		sub = stomp.subscribe(dest, (frame) => {
		  			console.log('ğŸ“¥ RECEIVED FRAME', frame);            // í—¤ë”/ë°”ë”” ë‹¤ ë³´ì„
		  			try {
		  				const m = JSON.parse(frame.body);
		  				console.log('ğŸ“© PARSED MSG', m);
		  				appendMessage(m);                                 // í™”ë©´ì— ì¶”ê°€
		  			} catch (e) {
		  				console.error('JSON parse error', e, frame.body);
		  			}
		  		});

		  	}, (err) => {
		  		console.error('âŒ STOMP connect error', err);
		  	});

		  	sock.onclose = scheduleReconnect;
		  }

		  function scheduleReconnect() {
		  	if (reconnecting) return;
		  	reconnecting = true;
		  	console.log('reconnect ì‹œë„ì¤‘');
		  	setTimeout(() => {reconnecting = false; connect();}, 3000);
		  }

		  function send() {
			console.log("ë£¸ì•„ì´ë””: " + roomId);
		  	const input = document.getElementById('msg');
		  	const text = input.value.trim();
		  	if (!text) return;

		  	if (!stomp || !stomp.connected) {
		  		return console.warn('âš ï¸ ì•„ì§ ì—°ê²° ì•ˆë¨. connect() ë¨¼ì € ì‹¤í–‰í•˜ì„¸ìš”.');
		  	}

		  	const payload = {
		  		type: 'SEND',
		  		chat_Room_Id: roomId,   // ì„œë²„ VO í•„ë“œëª…ê³¼ 100% ë™ì¼í•´ì•¼ í•¨
		  		sender: MY_ID,                  
		  		content: text
		  	};

		  	console.log('â¡ï¸ SEND payload', payload);
		  	stomp.send('/app/chat.send', {}, JSON.stringify(payload));
		  	input.value = '';
		  }
	  
		</script>

		<script
			src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>

		<script
			src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

		<th:block id="page-scripts"></th:block>
	</section>
</body>

</html>