<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<link rel="stylesheet" th:href="@{/css/admin-chat.css}" />

<body th:replace="~{admin/layout :: layout(~{::section}, ~{::#page-scripts})}">

	<section>
		<!-- <h3>ì›¹ì†Œì¼“ ì±„íŒ… ë°ëª¨</h3>
		<div>
			Room: <input id="roomId" value="room1"> 
			Nick: <input id="nick" value="user1">
			<button onclick="connect()">Connect</button>
			<button onclick="disconnect()">Disconnect</button>
		</div>
		
		<div style="margin-top: 8px">
			<input id="msg" placeholder="ë©”ì‹œì§€ ì…ë ¥" style="width: 80%">
			<button onclick="send()">Send</button>
		</div>
  <!-- ì¢Œì¸¡ ì±„íŒ…ë°© ëª©ë¡ -->
		<div class="chatroom_container">
			<div th:each="c : ${chatroom}" class="chatroom-card">
				<div class="chatroom-info">
					<div class="chatroom-name" th:text="${c.name}"></div>
					<div class="chatroom-lastmsg" th:text="${c.last_Message}"></div>
					<div class="chatroom-other" th:text="${c.other_User_Nickname}"></div>
				</div>
			</div>
		</div>

		<!-- ìš°ì¸¡ ì±„íŒ…ì˜ì—­ -->
		<div class="chat_area">
			<div class="chat_container">
				<div class="chat_each_container" th:each="chat : ${chat}">
					<div class="msg">
						<img th:src="@{${profile_Path}}" alt="profile" class="msg-profile">
						<div class="msg-bubble" th:text="${chat.content}"></div>
					</div>
				</div>
			</div>

			<!-- ì…ë ¥ì°½ -->
			<div class="chat-input">
				<input id="msg" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
				<button onclick="send()">ë³´ë‚´ê¸°</button>
				<button onclick="connect()">ì»¤ë„¥íŠ¸</button>
			</div>
		</div>

		<script th:inline="javascript">
			let stomp, sub;
			let currentRoomId = 1;   // ì§€ê¸ˆ ë³´ê³  ìˆëŠ” ë°© IDë¥¼ ì—¬ê¸°ë¡œ.
			let myId = [[${session.user_Id}]]; //ë¹¨ê°„ì¤„ ë¬´ì‹œ
			let reconnecting = false;

			function connect() {
				const sock = new SockJS('/ws-chat');
				stomp = Stomp.over(sock);

				// â‘  STOMP ë””ë²„ê·¸ ì¶œë ¥: SEND/SUBSCRIBE/MESSAGE í”„ë ˆì„ì„ ì½˜ì†”ì— ë‹¤ ë³´ì—¬ì¤Œ
				stomp.debug = (str) => console.log('[STOMP]', str);

				stomp.connect({}, () => {
					console.log('âœ… STOMP connected?', stomp.connected);

					// â‘¡ êµ¬ë… ì„¤ì • (ì„œë²„ê°€ convertAndSend("/topic/rooms/"+roomId) ë¡œ ë³´ë‚´ëŠ”ì§€ ê¼­ í™•ì¸!)
					const dest = `/topic/rooms/${currentRoomId}`;
					console.log('ğŸ”” SUBSCRIBE to', dest);
					if (sub) sub.unsubscribe();
					sub = stomp.subscribe(dest, (frame) => {
						console.log('ğŸ“¥ RECEIVED FRAME', frame);            // í—¤ë”/ë°”ë”” ë‹¤ ë³´ì„
						try {
							const m = JSON.parse(frame.body);
							console.log('ğŸ“© PARSED MSG', m);
							appendMessage(m);                                 // í™”ë©´ì— ì¶”ê°€
						} catch (e) {
							console.error('JSON parse error', e, frame.body);
						}
					});

				}, (err) => {
					console.error('âŒ STOMP connect error', err);
				});

				sock.onclose = scheduleReconnect;
			}

			function scheduleReconnect() {
				if (reconnecting) return;
				reconnecting = true;
				console.log('reconnect ì‹œë„ì¤‘');
				setTimeout(() => {reconnecting = false; connect();}, 3000);
			}

			function send() {
				const input = document.getElementById('msg');
				const text = input.value.trim();
				if (!text) return;

				if (!stomp || !stomp.connected) {
					return console.warn('âš ï¸ ì•„ì§ ì—°ê²° ì•ˆë¨. connect() ë¨¼ì € ì‹¤í–‰í•˜ì„¸ìš”.');
				}
				if (!currentRoomId) {
					return console.warn('âš ï¸ currentRoomId ë¯¸ì„¤ì •');
				}

				const payload = {
					type: 'SEND',
					chat_Room_Id: currentRoomId,   // ì„œë²„ VO í•„ë“œëª…ê³¼ 100% ë™ì¼í•´ì•¼ í•¨
					sender: myId,                  // ì„œë²„ VOê°€ ë°›ëŠ” í•„ë“œëª…ê³¼ ë™ì¼ (sender? senderId?)
					content: text
				};

				console.log('â¡ï¸ SEND payload', payload);
				stomp.send('/app/chat.send', {}, JSON.stringify(payload));
				input.value = '';
			}

			function appendMessage(m) {
				const wrap = document.querySelector('.chat_container');
				if (!wrap) {
					console.warn('chat_container ì—†ìŒ');
					return;
				}
				const msgDiv = document.createElement('div');
				msgDiv.className = 'msg';
				if (String(m.sender) === String(myId)) msgDiv.classList.add('me'); // íƒ€ì… ìºìŠ¤íŒ… ì•ˆì „í•˜ê²Œ

				const bubble = document.createElement('div');
				bubble.className = 'msg-bubble';
				bubble.textContent = m.content ?? ''; // textContentë¡œ XSS ì•ˆì „

				msgDiv.appendChild(bubble);
				wrap.appendChild(msgDiv);

				// ìŠ¤í¬ë¡¤ ë‹¤ìš´
				wrap.scrollTop = wrap.scrollHeight;
			}
		</script>
		<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
		<!-- ê·¸ ë‹¤ìŒ STOMP -->
		<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
		<!-- ë§ˆì§€ë§‰ì— ë‹¹ì‹ ì˜ chat.js (connect(), send() ì •ì˜ëœ íŒŒì¼) -->
	</section>
</body>

</html>