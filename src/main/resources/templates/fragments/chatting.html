<!-- templates/fragments/header.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<link rel="stylesheet" href="/css/userchat.css">
</head>


<body>
	<div id="chat-root" th:attr="data-userid=${session.user_Id}"></div>

	<!-- ê³ ì •ëœ + ë²„íŠ¼ -->
	<div id="open-chat" aria-label="ì±„íŒ… ì—´ê¸°" role="button">+</div>

	<!-- ì±„íŒ… íŒ¨ë„: ì²˜ìŒì—” ìˆ¨ê¹€ + floating ëª¨ë“œ -->
	<div class="chat_area floating hide">
		<!-- ì²˜ìŒì—” ìˆ¨ê¹€ -->
		<div class="chat_container">
			<div id="msgs" class="chat_each_container">
				<!-- ê¸°ì¡´ íƒ€ì„ë¦¬í”„ ë Œë”/JS ë Œë” ì˜ì—­ -->
			</div>
		</div>

		<div class="chat-input">
			<input id="msg" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
			<button onclick="send()">ë³´ë‚´ê¸°</button>
		</div>

		<div id="chat-newchat" class="hide">ê´€ë¦¬ìì™€ ì±„íŒ… ì—°ê²°</div>
	</div>
	
	<script th:inline="javascript">
		
		//set-user
		document.querySelectorAll('.set-user').forEach(link => { //forEach ë”ì— ìˆëŠ” ëª¨ë“  set-userì— ê´€í•´ ì´ ëª…ë ¹ì„ ìˆ˜í–‰
			link.addEventListener('click', function (e) { 
				e.preventDefault(); //í˜ì´ì§€ ë§¨ ìœ„ë¡œ ì í”„, í˜¹ì€ ë§í¬ë¡œ ì´ë™í•˜ë ¤ëŠ”ê±¸ ë§‰ê³  js ë¬¸ë²•ì„ ì™„ì „ ë¹„ë™ê¸°ë¡œ ì‹¤í–‰í•¨
				const userId = this.dataset.id; // ìœ„ì— ë‚´ê°€ ì¸ìë¡œ ì„¤ì •í•´ë‘” dataset.id ê°€ì ¸ì˜´
				
				console.log(/*[[${session.user_Id}]]*/); //session ê°’ ë³€ê²½ í›„ì—ëŠ” ìƒˆë¡œê³ ì¹¨ í•´ì•¼ ì ìš©ë¨
				
				const headers = {'Content-Type': 'application/x-www-form-urlencoded'}; 
				//id=5ì™€ ê°™ì€ í˜•ì‹ìœ¼ë¡œ ë³´ë‚¼ê±°ë¼ëŠ” ì˜ˆê³ ë¬¸, headers
				
				fetch('/set-user', {
					method: 'POST',
					headers, //id = 5 ê°™ì€ í˜•ì‹ìœ¼ë¡œ ë³´ë‚¸ë‹¤?
					body: `id=${userId}` //id = 5 ê°™ì€ í˜•ì‹ìœ¼ë¡œ ë³´ëƒ„
				})
				.then(res => res.json()) //jsonìœ¼ë¡œ íŒŒì‹±
				.then(data => { //íŒŒì‹±í•œ ê°’ì„ dataì— ë„£ìŒ
					console.log(`ì„¸ì…˜ ë³€ê²½ ì™„ë£Œ: ${data.status}, user id: ${data.user_Id}`); 
				});
			});
		}); //set-userë
		
		document.addEventListener('DOMContentLoaded', () => {
	    const openBtn   = document.getElementById('open-chat');
	    const chatArea  = document.querySelector('.chat_area');
	
		openBtn.addEventListener('click', onOpenChat);

	    async function onOpenChat() {
	      try {
	        // 1) ë‚´ ì±„íŒ…ë°© ê°œìˆ˜ í™•ì¸
	        const res = await fetch('/chat/user/chatroomcount');
	
	        // ìˆ«ì ì‘ë‹µì„ JSON í˜¹ì€ text ë‘˜ ë‹¤ ëŒ€ì‘
	        let count;
	       	count = await res.text();
	
	        if (Number(count) == 0) {
	          const res = await fetch('/newchat', {
		          method: 'POST'
		      });
	        }
	        
	        connect();
	        
	        const panel   = document.querySelector('.chat_area.floating');
       		const willOpen = panel.classList.contains('hide');
       	    panel.classList.toggle('hide', !willOpen);
       	    panel.classList.toggle('open', willOpen);

            loadRoom().catch(console.error);
          
	      } catch (err) {
	        console.error(err);
	        alert('ì±„íŒ… ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”.');
	      }
	    }
	  });
	</script>
	<script th:inline="javascript">
	  // ì „ì—­ ìƒíƒœ (ìƒëŒ€ ì •ë³´ & ë‚´ ì•„ì´ë””)
	  let roomId;
	  let MY_ID   = /*[[${session.user_Id}]]*/ 0; // í˜ì´ì§€ ìµœì´ˆ ì§„ì… ì‹œ ì„¸ì…˜ê°’
	  let OTHER_NAME = 'ìƒëŒ€';
	  let OTHER_PROFILE_URL = '/image/profile/default.png';
	
	  const chatArea = document.querySelector('.chat_area');
	  const msgs = document.getElementById('msgs');
	
	  // 1) ë°© ì—´ê¸°: ì„œë²„ì—ì„œ JSON ê°€ì ¸ì˜¤ê³  ê·¸ë¦¬ê¸°, ì»¤ë„¥íŠ¸
	  async function loadRoom() {
		//ì±„íŒ…ë°© ì•„ì´ë”” ê°€ì ¸ì˜¤ê¸°
		const getRoomId = await fetch(`/getchatroomid`) 
		//ê°€ì ¸ì˜¨ ì±„íŒ…ë°© ì•„ì´ë”” js ë³€ìˆ˜ì— ë„£ê¸°
		roomId = await getRoomId.text();
		//ê¸°ì¡´ chat data ê°€ì ¸ì˜¤ê¸°
	    const res = await fetch(`/chat/data?roomId=${roomId}`, {
	      headers: { 'Accept': 'application/json' }
	    });
	    if (!res.ok) throw new Error('HTTP ' + res.status);
		//json íŒŒì‹±
	    const data = await res.json();
		//ê°€ì ¸ì˜¨ ë°ì´í„° renderChat í•¨ìˆ˜ë¡œ ë„˜ê¸°ê¸°
	    renderChat(data);
	   
	    //websorket ì„œë²„ì— ì»¤ë„¥íŠ¸
	    connect();
	  }
	
	  // 2) ë¦¬ìŠ¤íŠ¸ ì „ì²´ ë Œë” (ê¸°ì¡´ ì§€ìš°ê³  ë‹¤ì‹œ ê·¸ë¦¼)
	  function renderChat(data) {
		  
		MY_ID = data.myId;
	    OTHER_NAME = data?.otheruser?.other_User_Name || 'ìƒëŒ€';
	    OTHER_PROFILE_URL = data?.otheruser?.other_User_Profile
	      ? `/image/profile/${data.otheruser.other_User_Profile}`
	      : '/image/profile/default.png';
	
	    // ê¸°ì¡´ ë©”ì‹œì§€ ì‚­ì œ
	    msgs.innerHTML = '';
		//ì±„íŒ… ë°ì´í„° ê°œìˆ˜ë§Œí¼ í•¨ìˆ˜ ì‹¤í–‰
		
	    (data.chat || []).forEach(m => appendMessage(m, MY_ID));
	    // ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
	    msgs.scrollTop = msgs.scrollHeight;
	  }
	
	  // 3) í•œ ì¤„ ì¶”ê°€ (ê³¼ê±° ë©”ì‹œì§€/ì›¹ì†Œì¼“ ìˆ˜ì‹  ê³µìš©)
	  function appendMessage(m, myIdFromData = MY_ID) {
	    const isMe = Number(m.sender) === Number(myIdFromData);
	
	    const row = document.createElement('div');
	    row.className = 'msg' + (isMe ? ' me' : '');
	
	    if (!isMe) {
	      const img = document.createElement('img');
	      img.className = 'msg-profile';
	      img.alt = 'profile';
	      img.src = OTHER_PROFILE_URL;
	      row.appendChild(img);
	    }
	
	    const body = document.createElement('div');
	    body.className = 'msg-body';
	
	    if (!isMe) {
	      const meta = document.createElement('div');
	      meta.className = 'meta';
	      meta.textContent = OTHER_NAME;
	      body.appendChild(meta);
	    }
	
	    const bubble = document.createElement('div');
	    bubble.className = 'msg-bubble';
	    bubble.textContent = m.content ?? '';
	    body.appendChild(bubble);
	
	    row.appendChild(body);
	    msgs.appendChild(row);
	    msgs.scrollTop = msgs.scrollHeight;
	  }
	
	 
	</script>

	<script>
		
		let stomp, sub;
		let reconnecting = false;
		
		function connect() {
			const sock = new SockJS('/ws-chat');
			stomp = Stomp.over(sock);
		
			// â‘  STOMP ë””ë²„ê·¸ ì¶œë ¥: SEND/SUBSCRIBE/MESSAGE í”„ë ˆì„ì„ ì½˜ì†”ì— ë‹¤ ë³´ì—¬ì¤Œ
			stomp.debug = (str) => console.log('[STOMP]', str);
		
			stomp.connect({}, () => {
				console.log('âœ… STOMP connected?', stomp.connected);
		
				// â‘¡ êµ¬ë… ì„¤ì • (ì„œë²„ê°€ convertAndSend("/topic/rooms/"+roomId) ë¡œ ë³´ë‚´ëŠ”ì§€ ê¼­ í™•ì¸!)
				
				
				const dest = `/topic/rooms/${roomId}`;
				console.log('ğŸ”” SUBSCRIBE to', dest);
				if (sub) sub.unsubscribe();
				sub = stomp.subscribe(dest, (frame) => {
					console.log('ğŸ“¥ RECEIVED FRAME', frame);            // í—¤ë”/ë°”ë”” ë‹¤ ë³´ì„
					try {
						const m = JSON.parse(frame.body);
						console.log('ğŸ“© PARSED MSG', m);
						appendMessage(m);                                 // í™”ë©´ì— ì¶”ê°€
					} catch (e) {
						console.error('JSON parse error', e, frame.body);
					}
				});
		
			}, (err) => {
				console.error('âŒ STOMP connect error', err);
			});
		
			sock.onclose = scheduleReconnect;
		}
		
		function scheduleReconnect() {
			if (reconnecting) return;
			reconnecting = true;
			console.log('reconnect ì‹œë„ì¤‘');
			setTimeout(() => {reconnecting = false; connect();}, 3000);
		}
		
		function send() {
			const input = document.getElementById('msg');
			const text = input.value.trim();
			if (!text) return;
		
			if (!stomp || !stomp.connected) {
				return console.warn('âš ï¸ ì•„ì§ ì—°ê²° ì•ˆë¨. connect() ë¨¼ì € ì‹¤í–‰í•˜ì„¸ìš”.');
			}
		
			const payload = {
				type: 'SEND',
				chat_Room_Id: roomId,
				sender: MY_ID,                  
				content: text
			};
		
			console.log('â¡ï¸ SEND payload', payload);
			stomp.send('/app/chat.send', {}, JSON.stringify(payload));
			input.value = '';
		}
	</script>

	<script
		src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>

	<script
		src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
	

</body>

</html>