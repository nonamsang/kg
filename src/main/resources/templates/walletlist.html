<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">

<head>
	<meta charset="UTF-8">
	<title>ì§€ê°‘ ëª©ë¡</title>

	<link rel="stylesheet" href="/css/mainpagestyle.css">
	<link rel="stylesheet" href="/css/wallet.css"> <!-- wallet.css -->
	<!-- ê¸°ë¶€ ëª¨ë‹¬ CSS -->
	<link rel="stylesheet" href="/css/donate.css">

	<link rel="stylesheet" href="/css/sidebar.css?v=7">
	
	<script src="https://cdn.iamport.kr/v1/iamport.js"></script>
</head>

<body>

	<!-- â¬‡ï¸ confetti ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ-->
	<script src="/js/confetti.min.js"></script>


	<!-- ê³µí†µ header ì‚½ì… -->
	<div th:replace="fragments/header :: header"></div>

	<!-- ğŸŒ™/â˜€ï¸ ë‹¤í¬ëª¨ë“œ í† ê¸€ ë²„íŠ¼ -->
	<button id="lfThemeToggle" class="lf-theme-toggle" aria-label="ë‹¤í¬ ëª¨ë“œ í† ê¸€">
		<img id="lfThemeIcon" src="/images/sidebar/darkmode.png" alt="ë‹¤í¬ ëª¨ë“œë¡œ ì „í™˜" />
	</button>


	<!-- ì‚¬ì´ë“œë°” + ë³¸ë¬¸ ë˜í¼ ì‹œì‘ -->
	<div class="page-with-sidebar">
		<!-- [ì¢Œ] ì‚¬ì´ë“œë°” í”„ë˜ê·¸ë¨¼íŠ¸ -->
		<div th:replace="fragments/sidebar :: sidebar"></div>

		<div class="page-content">
			<div class="passbook-wrapper">
				<div class="passbook-bg">
					<!-- í•­ìƒ ê¹”ë¦° ë°°ê²½ (ì²˜ìŒì—” ë‹«íŒ ê·¸ë¦¼) -->
					<img id="passbookBg" src="/image/passbook_closed.png" class="passbook-background" alt="í†µì¥ ë°°ê²½">

					<!-- âœ… ì¢…ì´ ë„˜ê¹€ ì»¨í…Œì´ë„ˆ(ë¹„ì›Œë‘ ) -->
					<div class="paper-frame" aria-hidden="true"></div>

					<div class="wallet-tabs wallet-tabs--over">
						<button class="tab" th:each="bank : ${bankNames}" th:attr="data-bank=${bank}"
							th:text="${bank}">ì€í–‰</button>
						<button class="tab" id="addBank">âŠ• ê³„ì¢Œ ì¶”ê°€í•˜ê¸°</button>
						<span class="tabs-help"> íƒ­ì„ ëˆŒëŸ¬ í†µì¥ ìƒì„¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.</span>
					</div>

					<!-- ìƒë‹¨ ê³µí†µ ì˜ì—­ (ê¸°ë¶€ ë²„íŠ¼ í•­ìƒ ì´ ìë¦¬) -->
					<div class="passbook-top section-narrow">
						<div class="info-section">
							<p class="username">
								<strong th:text="${userInfo.nickname}">í™ê¸¸ë™</strong> ë‹˜
							</p>
							<p class="summary">
								ì´ ìì‚°: <strong
									th:text="${#numbers.formatInteger(totalBalance,3,'COMMA')} + 'ì›'">0ì›</strong>
							</p>
							<p class="banks">
								ë³´ìœ  ì€í–‰:
								<span th:text="${#strings.listJoin(bankNames, ', ')}">-</span>
							</p>
						</div>
						
						<button id = "addBalance">ì”ì•¡ ì¶”ê°€í•˜ê¸°</button>
					</div>
					<!-- ê¸°ë¶€í•˜ê¸°ë²„íŠ¼ -->
					<div class="passbook-cta">
						<button type="button" id="openDonateModal" class="btn btn-primary btn-jittery"
							aria-label="ê¸°ë¶€ ëª¨ë‹¬ ì—´ê¸°">ê¸°ë¶€í•˜ê¸°</button>
					</div>

					<!-- ì€í–‰ë³„ íŒ¨ë„ : íƒ­ í´ë¦­ ì‹œ í•´ë‹¹ ì€í–‰ë§Œ í‘œì‹œ -->
					<div class="passbook-content bank-panel" th:each="bankName : ${bankNames}"
						th:attr="data-bank=${bankName}">
						<!-- ìœ„ìª½ ì˜ì—­ (í‘œ) -->
						<section class="panel-top">
							<table class="wallet-table">
								<thead>
									<tr>
										<th>ì€í–‰ëª…</th>
										<th>ê³„ì¢Œë²ˆí˜¸</th>
										<th>ì”ì•¡</th>
									</tr>
								</thead>
								<tbody>
									<tr th:each="wallet : ${walletList}" th:if="${wallet.bank_Name == bankName}">
										<td th:text="${wallet.bank_Name}">ì€í–‰ëª…</td>
										<td th:text="${wallet.account_Number}">ê³„ì¢Œë²ˆí˜¸</td>
										<td th:text="${#numbers.formatInteger(wallet.account_Balance,3,'COMMA')} + 'ì›'">
											0ì›</td>
									</tr>
								</tbody>
							</table>
						</section>

						<!-- ì•„ë˜ìª½ ì˜ì—­ (ìƒì„¸/ì•ˆë‚´) -->
						<section class="panel-bottom">
							<div class="bank-details">
								<p>ê°€ì…ì‹ ì²­ì¼: <span>2005ë…„ 1ì›” 1ì¼</span></p>
								<p>í†µì¥ë°œí–‰ì¼: <span>2015ë…„ 1ì›” 1ì¼</span></p>
								<p>ê°€ì…ì‹ ì²­ì í¬: êµ­íšŒì§€ì </p>
								<p>í†µì¥ë°œí–‰ì í¬: LFì§€ì </p>
							</div>
							<div class="bank-notice">
								<p>ğŸ’¡ ë³¸ í†µì¥ì€ Little Forest ì„œë¹„ìŠ¤ì—ì„œ ë°œê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
								<p>ğŸ’¡ ìì„¸í•œ ì‚¬í•­ì€ ê³ ê°ì„¼í„° ë˜ëŠ” í™ˆí˜ì´ì§€ë¥¼ ì°¸ì¡°í•´ ì£¼ì„¸ìš”.</p>
							</div>
						</section>
					</div>

					<!-- ===========================ê¸°ë¶€ ëª¨ë‹¬========================== -->
					<div id="donateModal" class="donate-modal" aria-hidden="true" style="display:none">
						<div class="donate-dialog" role="dialog" aria-modal="true" aria-labelledby="donateTitle">
							<div class="donate-header">
								<div class="donate-tabs">
									<button class="donate-tab donate-tab--pay" type="button">í¬ì¸íŠ¸ ì¶©ì „í•˜ëŸ¬ê°€ê¸°</button>
									<button class="donate-tab" data-pane="recurring">ì •ê¸°ê¸°ë¶€í•˜ê¸°</button>
									<button class="donate-tab active" data-pane="oneoff">ë³´ìœ ê¸ˆì•¡ ê¸°ë¶€í•˜ê¸°</button>
								</div>
								<button type="button" class="donate-close" id="closeDonateModal"
									aria-label="ë‹«ê¸°">Ã—</button>
							</div>

							<div class="donate-body">
								<h2 id="donateTitle" class="donate-quote">
									â€œê¸°ë¶€ìë‹˜ì˜ ì†Œì¤‘í•œ ë§ˆìŒìœ¼ë¡œ ë§Œë“œëŠ” ì‘ì€ ìˆ², <p>ë†€ë¼ìš´ ë³€í™”ê°€ ì‹œì‘ë©ë‹ˆë‹¤.â€
								</h2>
								<p class="donate-sub">íˆ¬ëª…í•œ ê¸°ë¶€ í›„ê¸°ë¡œ ê·¸ ë³€í™”ë¥¼ ì†Œê°œí•˜ê³  ë³´ë‹µí•˜ê² ìŠµë‹ˆë‹¤!</p>

								<div class="donate-pane active" data-pane="oneoff">
									<div class="donate-grid">
										<!-- ê¸ˆì•¡ ì…ë ¥ ì˜ì—­ -->
										<div class="donate-left">
											<div class="amount-row">
												<label for="donationAmount">ê¸°ë¶€í•  í¬ì¸íŠ¸</label>
												<div class="amount-input-wrap">
													<input id="donationAmount" type="number" inputmode="numeric"
														min="1000" step="100" placeholder="ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”(ì›)"
														aria-describedby="amountHelp">
													<span class="unit">ì›</span>
												</div>
												<div id="amountHelp" class="help">ï¼Šê¸°ë¶€ë¥¼ ì›í•˜ëŠ” ê¸ˆì•¡ì„ ì…ë ¥í•œ í›„ <b>ê¸°ë¶€í•˜ê¸°</b>ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.
												</div>
												<div class="quick-buttons">
													<button type="button" data-amt="1000">1ì²œì›</button>
													<button type="button" data-amt="5000">5ì²œì›</button>
													<button type="button" data-amt="10000">1ë§Œì›</button>
													<button type="button" data-amt="20000">2ë§Œì›</button>
													<button type="button" data-amt="30000">3ë§Œì›</button>
												</div>
											</div>

											<div class="method-row">
												<div class="method-pill">ë³´ìœ  í¬ì¸íŠ¸</div>
												<span class="point-balance" th:attr="data-balance=${pointBalance}"
													th:text="'ë³´ìœ  ' + ${#numbers.formatInteger(pointBalance, 3, 'COMMA')} + ' P'">
													ë³´ìœ  0 P
												</span>
											</div>

											<!-- ì•ˆë‚´/í™•ì¸ ì˜ì—­ -->
											<aside class="donate-right">
												<div class="notice-box">
													<p class="title">ìˆ˜ìˆ˜ë£Œ ì—†ì´ 100% ê¸°ë¶€</p>
													<p class="desc">ê²°ì œí•˜ì‹  ê¸ˆì•¡ì€ ìˆ˜ìˆ˜ë£Œ ì—†ì´ <b>ë‹¨ì²´ë¡œ 100% ì „ë‹¬</b>ë©ë‹ˆë‹¤.</p>
												</div>

												<div class="org-box">
													<label class="checkbox">
														<input type="checkbox" id="agreeOrg" checked>
														<span>í¬ì¸íŠ¸ ê¸°ë¶€ ë™ì˜í•˜ê¸°</span>
													</label>
													<label class="checkbox">
														<input type="checkbox" id="agreeInfo">
														<span>(ì„ íƒ) ë¦¬í‹€í¬ë ˆìŠ¤íŠ¸ ë§ˆì¼€íŒ… ì•Œë¦¼ ìˆ˜ì‹ ì— ë™ì˜í•©ë‹ˆë‹¤.</span>
													</label>
												</div>

												<button type="button" id="btnDonate"
													class="donate-btn donate-btn--wave">
													<span class="wave" aria-hidden="true"></span>
													<span class="label">ê¸°ë¶€í•˜ê¸°</span>
												</button>
											</aside>
										</div>
									</div>
								</div>
								

								<!-- =========================ì •ê¸°ê¸°ë¶€ pane==================== -->
								<div class="donate-pane" data-pane="recurring">
									<div class="donate-grid">
										<!-- ì™¼ìª½: ê¸ˆì•¡/ìŠ¤ì¼€ì¤„ -->
										<div class="donate-left">
											<div class="amount-row">
												<label for="recurringAmount">ë§¤ì›” ê¸°ë¶€í•  í¬ì¸íŠ¸</label>
												<div class="amount-input-wrap">
													<input id="recurringAmount" type="number" inputmode="numeric"
														min="20000" step="1000" placeholder="ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”(ì›)">
													<span class="unit">ì›</span>
												</div>
												<div class="help">ï¼Šì •ê¸°ê¸°ë¶€ëŠ” <b>20,000ì› ì´ìƒ</b>ë¶€í„° ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
												<div class="quick-buttons">
													<button type="button" data-amt="20000">2ë§Œì›</button>
													<button type="button" data-amt="30000">3ë§Œì›</button>
													<button type="button" data-amt="50000">5ë§Œì›</button>
													<button type="button" data-amt="100000">10ë§Œì›</button>
												</div>
											</div>

											<!-- ë‚ ì§œ ì„ íƒ -->
											<div class="schedule-row">
												<label class="radio">
													<input type="radio" name="rc_daytype" value="day" checked>
													ë§¤ì›”
													<select id="rcDaySelect" aria-label="ë§¤ì›” ë©°ì¹ ">
														<!-- 1~28ì¼: ëª¨ë“  ë‹¬ì—ì„œ ì•ˆì „ -->
														<option value="1">1ì¼</option>
														<option value="5">5ì¼</option>
														<option value="10">10ì¼</option>
														<option value="15" selected>15ì¼</option>
														<option value="20">20ì¼</option>
														<option value="25">25ì¼</option>
														<option value="28">28ì¼</option>
													</select>
													ì— ìë™ ê¸°ë¶€
												</label>
												<label class="radio">
													<input type="radio" name="rc_daytype" value="last">
													ë§¤ì›” <b>ë§ì¼</b>ì— ìë™ ê¸°ë¶€
												</label>
											</div>
											<div class="help schedule-help">ï¼Š2ì›” ë“± ì§§ì€ ë‹¬ì—ëŠ” ì„ íƒì¼ì´ ì—†ìœ¼ë©´ ìë™ìœ¼ë¡œ ë§ì¼ì— ì²˜ë¦¬ë©ë‹ˆë‹¤.</div>
										</div>

										<!-- ì˜¤ë¥¸ìª½: ì•ˆë‚´/ë™ì˜/ë²„íŠ¼ -->
										<aside class="donate-right">
											<div class="notice-box">
												<p class="title">ì •ê¸°ê¸°ë¶€ ì•ˆë‚´</p>
												<p class="desc">ì„¤ì •í•œ ë‚ ì§œì— ë³´ìœ  í¬ì¸íŠ¸ì—ì„œ <b>ìë™ ì°¨ê°</b>ë©ë‹ˆë‹¤.</p>
											</div>

											<div class="org-box">
												<label class="checkbox">
													<input type="checkbox" id="agreeOrgRc" checked>
													<span>ì •ê¸°ê¸°ë¶€ì— ë™ì˜í•©ë‹ˆë‹¤</span>
												</label>
											</div>
											<button type="button" id="btnRecurring" class="donate-btn">
												ì •ê¸°ê¸°ë¶€ ì‹ ì²­
											</button>
										</aside>
									</div>
								</div> <!-- donate-panel -->
							</div> <!-- /donate-body -->
						</div><!-- /donate-dialog -->
					</div><!-- /donateModal -->
				</div> <!-- passbook-bg -->
			</div>
		</div>
	</div>
	
	<!-- Add Bank Modal -->
	<div class="lf-modal" id="addBankModal" hidden>
	  <div class="lf-modal__overlay" data-dismiss></div>
	  <div class="lf-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="addBankTitle">
	    <button class="lf-modal__close" type="button" data-dismiss aria-label="ë‹«ê¸°">Ã—</button>
	    <h2 class="lf-modal__title" id="addBankTitle">ê³„ì¢Œ ì¶”ê°€</h2>
	
	    <form id="addBankForm" class="lf-form">
	      <label class="lf-field">
	        <span class="lf-label">ì€í–‰ëª…</span>
	        <input id="bankName" name="bankName" type="text" required placeholder="ì˜ˆ: ì¹´ì¹´ì˜¤ë±…í¬" />
	      </label>
	
	      <label class="lf-field">
	        <span class="lf-label">ê³„ì¢Œë²ˆí˜¸</span>
	        <input id="accountNumber" name="accountNumber" type="text" required inputmode="numeric" placeholder="ìˆ«ìë§Œ ì…ë ¥" />
	      </label>
	
	      <div class="lf-actions">
	        <button class="lf-btn lf-btn--primary" type="submit">ì¶”ê°€</button>
	        <button class="lf-btn" type="button" data-dismiss>ì·¨ì†Œ</button>
	      </div>
	    </form>
	  </div>
	</div>
	
	<!-- Add Balance Modal -->
	<div class="lf-modal" id="addBalanceModal" hidden>
	  <div class="lf-modal__overlay" data-dismiss></div>
	  <div class="lf-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="addBalanceTitle">
	    <button class="lf-modal__close" type="button" data-dismiss aria-label="ë‹«ê¸°">Ã—</button>
	    <h2 class="lf-modal__title" id="addBalanceTitle">ì”ì•¡ ì¶”ê°€</h2>
	
	    <form id="addBalanceForm" class="lf-form">
	      <p class="lf-help">ì„ íƒëœ ì€í–‰ í†µì¥ì— ê¸ˆì•¡ì„ ì¶”ê°€í•©ë‹ˆë‹¤.</p>
	      <label class="lf-field">
	        <span class="lf-label">ì¶”ê°€í•  ê¸ˆì•¡</span>
	        <input id="addAmount" name="amount" type="number" inputmode="numeric"
	               min="1" step="1" required placeholder="ì˜ˆ: 50000" />
	      </label>
	
	      <div class="lf-actions">
	        <button class="lf-btn lf-btn--primary" type="submit">ì¶”ê°€</button>
	        <button class="lf-btn" type="button" data-dismiss>ì·¨ì†Œ</button>
	      </div>
	    </form>
	  </div>
	</div>


	<!-- ê³µí†µ footer ì‚½ì… -->
	<div th:replace="fragments/footer :: footer"></div>

	<!-- â¬‡ï¸ confetti íƒ€ê¹ƒ + ì´ˆê¸°í™” (í•œ ë²ˆë§Œ) -->
	<script>
		// 1) í™”ë©´ ì „ì²´ë¥¼ ë®ëŠ”, ëˆˆì— ì•ˆ ë³´ì´ëŠ” íƒ€ê¹ƒ(í´ë¦­ ì´ë²¤íŠ¸ë§Œ ë°›ìŒ)
		const _confettiTarget = document.createElement('button');
		_confettiTarget.id = 'confettiTarget';
		_confettiTarget.type = 'button';
		_confettiTarget.style.cssText = 'position:fixed;inset:0;opacity:0;pointer-events:none;';
		document.body.appendChild(_confettiTarget);

		// 2) confetti ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
		const confetti = new Confetti('confettiTarget');
		confetti.destroyTarget(false);  // íƒ€ê¹ƒì„ ìˆ¨ê¸°ì§€ ì•Šë„ë¡
		confetti.setCount(120);         // íŒŒí‹°í´ ìˆ˜
		confetti.setPower(40);          // í„°ì§€ëŠ” ì„¸ê¸°
		confetti.setSize(1.2);          // íŒŒí‹°í´ í¬ê¸°
		confetti.setFade(true);         // ì„œì„œíˆ ì‚¬ë¼ì§

		// 3) í˜¸ì¶œ í•¨ìˆ˜: ì¤‘ì•™ì—ì„œ ë°œì‚¬
		function shootConfetti() {
			const x = window.innerWidth / 2;
			const y = window.innerHeight / 2;
			_confettiTarget.dispatchEvent(new MouseEvent('click', {clientX: x, clientY: y}));
		}
	</script>

	<script>
		document.addEventListener("DOMContentLoaded", function () {

			// í˜¹ì‹œ ë‚¨ì•„ìˆëŠ” half.png ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ì •ë¦¬
			document.querySelectorAll('img.passbook-flip').forEach(el => el.remove());

			// paper-frame ì•ˆì— ê°€ì§œ ì¢…ì´(div) ì¤€ë¹„
			const frame = document.querySelector('.paper-frame');
			let flip = frame?.querySelector('.passbook-flip.fx');
			if (!flip && frame) {
				flip = document.createElement('div');
				flip.className = 'passbook-flip fx';
				frame.appendChild(flip);
			}


			const tabs = document.querySelectorAll('.wallet-tabs .tab[data-bank]');
			const addBankBtn = document.getElementById('addBank');
			
			const panels = document.querySelectorAll('.bank-panel');
			const bg = document.getElementById('passbookBg');
			const infoBox = document.querySelector('.passbook-top .info-section');
			let opened = false;
			let currentBank = null;

			function showPanel(bank) {
				// ê¸°ì¡´ íƒ­/íŒ¨ë„ ë¡œì§ ìœ ì§€
				currentBank = bank;
				tabs.forEach(t => t.classList.toggle('selected', t.dataset.bank === bank));
				panels.forEach(p => {
					const on = p.dataset.bank === bank;
					p.style.display = on ? 'block' : 'none';
					p.classList.toggle('is-visible', on);
				});
				if (infoBox) infoBox.style.display = 'block';

				// ì²« íƒ­ í´ë¦­ì€ í¼ì¹œ ë°°ê²½ë§Œ êµì²´(ê¸°ì¡´ëŒ€ë¡œ)
				if (!opened) {bg.src = '/image/passbook.png'; opened = true; return;}

				// ì´í›„ë¶€í„°: ì˜ìƒì²˜ëŸ¼ ì•„ë˜â†’ìœ„ 3D í”Œë¦½
				if (!flip) return;
				flip.classList.remove('run');
				void flip.offsetWidth;      // reflowë¡œ ì¬íŠ¸ë¦¬ê±°
				flip.classList.add('run');

				// ëë‚˜ë©´ ì´ˆê¸°í™”
				const done = (e) => {
					if (e.animationName === 'lfFlipUp3D') {
						flip.classList.remove('run');
						flip.removeEventListener('animationend', done);
					}
				};
				flip.addEventListener('animationend', done);
			}
			
			addBank.addEventListener('click', () => {
			});

			tabs.forEach(tab => tab.addEventListener('click', () => showPanel(tab.dataset.bank)));


			// === ê¸°ë¶€ ëª¨ë‹¬ ===
			const modal = document.getElementById('donateModal');
			const openBtn = document.getElementById('openDonateModal');
			const closeBtn = document.getElementById('closeDonateModal');
			const addBalanceBtn = document.getElementById('addBalance');
			const donateBtn = document.getElementById('btnDonate');
			const balEl = document.querySelector('.point-balance');
			const currentBalance = Number(balEl?.dataset.balance || 0); // ì„œë²„ ê°’
			
			const selectedBank = document.querySelector('.tab[data-bank]');
			const selectedBankName = selectedBank.dataset.bank;

			// ê¸ˆì•¡ ì…ë ¥ ì‹œ ë³´ìœ  ì´ˆê³¼ ë°©ì§€(ì„ ì œì  ìº¡)
			const amountInput = document.getElementById('donationAmount');
			amountInput.addEventListener('input', () => {
				const v = Number(amountInput.value || 0);
				if (v > currentBalance) amountInput.value = currentBalance;
			});

			openBtn.addEventListener('click', () => {
				modal.style.display = 'block';
				modal.setAttribute('aria-hidden', 'false');
				amountInput.focus();
			});
			closeBtn.addEventListener('click', () => {
				modal.style.display = 'none';
				modal.setAttribute('aria-hidden', 'true');
			});
			modal.addEventListener('click', (e) => {
				if (e.target === modal) closeBtn.click(); // ë°”ê¹¥ í´ë¦­ ë‹«ê¸°
			});
			document.addEventListener('keydown', (e) => {
				if (e.key === 'Escape' && modal.style.display === 'block') closeBtn.click();
			});

			
			addBalanceBtn.addEventListener('click', async () => {
				alert(currentBank);
				
				
			})
			// ê¸°ë¶€í•˜ê¸° í´ë¦­
			donateBtn.addEventListener('click', async () => {
				const amt = Number(amountInput.value || 0);
				if (Number.isNaN(amt) || amt < 1000) {
					alert('1,000ì› ì´ìƒë¶€í„° ê¸°ë¶€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
					amountInput.focus();
					return;
				}
				if (!document.getElementById('agreeOrg').checked) {
					alert('ë‹¨ì²´ í™•ì¸ì— ë™ì˜í•´ ì£¼ì„¸ìš”.');
					return;
				}

				try {
					const res = await fetch('/donations/point', {
						method: 'POST',
						headers: {'Content-Type': 'application/x-www-form-urlencoded'},
						body: new URLSearchParams({amount: amt})
					});

					if (!res.ok) {
						const msg = await res.text();
						throw new Error(msg || 'ê¸°ë¶€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
					}

					const data = await res.json();

					shootConfetti();                 // confettiíš¨ê³¼

					alert('ê¸°ë¶€ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤!');

					// í¬ì¸íŠ¸ ì”ì•¡ ê°±ì‹  í‘œì‹œ (ëª¨ë¸ë¡œ ë‚´ë ¤ì¤€ ì˜ì—­ì´ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸)
					// í‘œì‹œ ê°±ì‹ 
					balEl.dataset.balance = data.newBalance;
					balEl.textContent = 'ë³´ìœ  ' + Number(data.newBalance).toLocaleString() + ' P';
					amountInput.value = '';
					closeBtn.click();
				} catch (e) {alert(e.message);}
			});

			//============ ê³„ì¢Œ ì¶”ê°€ ëª¨ë‹¬ ================
			const addModal = document.getElementById('addBankModal');
			const form = document.getElementById('addBankForm');

			function openModal() {
			    addModal.hidden = false;
			    document.body.style.overflow = 'hidden';
			    // ì²« ì…ë ¥ í¬ì»¤ìŠ¤
			    setTimeout(() => document.getElementById('bankName')?.focus(), 0);
			  }
			  function closeModal() {
			    addModal.hidden = true;
			    document.body.style.overflow = '';
			    form.reset();
			  }

			  addBankBtn?.addEventListener('click', (e) => {
			    e.preventDefault();
			    openModal();
			  });

			  // ë‹«ê¸° (ì˜¤ë²„ë ˆì´, ì·¨ì†Œ, X ë²„íŠ¼)
			  addModal?.addEventListener('click', (e) => {
			    if (e.target.matches('[data-dismiss]')) closeModal();
			  });
			  document.addEventListener('keydown', (e) => {
			    if (!modal.hidden && e.key === 'Escape') closeModal();
			  });

			  // ì œì¶œ
			  form?.addEventListener('submit', (e) => {
			    e.preventDefault();
			    const fd = new FormData(form);
			    const bankName = fd.get('bankName');
			    const account_Number = fd.get('accountNumber');
				
			    fetch('/wallet/addBank', {
		    		  method: 'POST',
		    		  headers: {
		    		    'Content-Type': 'application/json'
		    		  },
		    		  body: JSON.stringify({
		    			  bankName,
		    			  account_Number
		    		  })
		    		});

			    closeModal();
			    
			    window.location.reload()
			  });



			// ---------- ëª¨ë‹¬ íƒ­ ì „í™˜ ----------
			const donateTabBtns = document.querySelectorAll('.donate-tabs .donate-tab[data-pane]');
			const donatePanes = document.querySelectorAll('.donate-pane');

			function setDonateTab(target) { // 'oneoff' | 'recurring'
				donateTabBtns.forEach(b => b.classList.toggle('active', b.dataset.pane === target));
				donatePanes.forEach(p => p.classList.toggle('active', p.dataset.pane === target));
			}

			// ëª¨ë‹¬ ì—´ ë•Œ í•­ìƒ ì¼ì‹œ(ë³´ìœ ê¸ˆì•¡) ë¨¼ì €
			openBtn.addEventListener('click', () => {
				setDonateTab('oneoff');
			});

			// íƒ­ í´ë¦­ìœ¼ë¡œ ì „í™˜
			donateTabBtns.forEach(btn => {
				btn.addEventListener('click', () => setDonateTab(btn.dataset.pane));
			});

			// ---------- ë¹ ë¥¸ ê¸ˆì•¡ ë²„íŠ¼(ë‘ pane ê³µí†µ) ----------
			document.querySelectorAll('.quick-buttons button').forEach(b => {
				b.addEventListener('click', () => {
					// ìì‹ ì´ ì†í•œ pane ì•ˆì˜ number inputì— ì£¼ì…
					const pane = b.closest('.donate-pane');
					const input = pane.querySelector('input[type="number"]');
					if (input) input.value = b.dataset.amt;
				});
			});

			// ---------- ì •ê¸°ê¸°ë¶€ ì‹ ì²­ ----------
			const rcAmountInput = document.getElementById('recurringAmount');
			const rcDaySelect = document.getElementById('rcDaySelect');
			const rcBtn = document.getElementById('btnRecurring');

			// ë§ì¼ ì„ íƒ ì‹œ day select ë¹„í™œì„±í™”
			document.querySelectorAll('input[name="rc_daytype"]').forEach(r => {
				r.addEventListener('change', () => {
					const v = document.querySelector('input[name="rc_daytype"]:checked')?.value;
					rcDaySelect.disabled = (v !== 'day');  // 'last'ë©´ ë¹„í™œì„±í™”
				});
			});

			rcBtn.addEventListener('click', async () => {
				const amt = Number(rcAmountInput.value || 0);
				if (Number.isNaN(amt) || amt < 20000) {
					alert('ì •ê¸°ê¸°ë¶€ëŠ” 20,000ì› ì´ìƒë¶€í„° ê°€ëŠ¥í•©ë‹ˆë‹¤.');
					rcAmountInput.focus(); return;
				}
				if (!document.getElementById('agreeOrgRc').checked) {
					alert('ì •ê¸°ê¸°ë¶€ ë™ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
					return;
				}

				const dayType = document.querySelector('input[name="rc_daytype"]:checked')?.value; // 'day' | 'last'
				const dueDay = (dayType === 'day') ? Number(rcDaySelect.value) : null;

				try {
					// ì„œë²„ì— ë§ê²Œ ì—”ë“œí¬ì¸íŠ¸ë§Œ ë°”ê¿”ì£¼ì„¸ìš”.
					const res = await fetch('/donations/recurring', {
						method: 'POST',
						headers: {'Content-Type': 'application/x-www-form-urlencoded'},
						body: new URLSearchParams({
							amount: amt,                       // ê¸ˆì•¡(ì›)
							schedule: dayType === 'last' ? 'LASTDAY' : `DAY:${dueDay}` // ìŠ¤ì¼€ì¤„
						})
					});

					if (!res.ok) {
						const msg = await res.text();
						throw new Error(msg || 'ì •ê¸°ê¸°ë¶€ ì‹ ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
					}

					alert('ì •ê¸°ê¸°ë¶€ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤!');
					rcAmountInput.value = '';
					setDonateTab('oneoff'); // ì™„ë£Œ í›„ ì¼ì‹œ íƒ­ìœ¼ë¡œ ëŒë ¤ë†“ê¸°(ì„ íƒ)
				} catch (e) {
					alert(e.message);
				}
			});

			/*     í¬ì¸íŠ¸ ì¶©ì „í•˜ëŸ¬ê°€ê¸°  */
			document.querySelector('.donate-tab--pay')?.addEventListener('click', () => {
				window.location.href = '/pay';
			});

		});




		/* ========================= dark mode ========================= */
		(function () {
			const KEY = 'lfTheme'; // 'light' | 'dark'
			const root = document.documentElement; // <html>

			function applyTheme(mode) {
				if (mode === 'dark') {
					root.classList.add('theme-dark');
					swapIcon('dark');
					localStorage.setItem(KEY, 'dark');
				} else {
					root.classList.remove('theme-dark');
					swapIcon('light');
					localStorage.setItem(KEY, 'light');
				}
			}

			function swapIcon(mode) {
				const img = document.getElementById('lfThemeIcon');
				if (!img) return;
				if (mode === 'dark') {
					img.src = '/images/whitemode.png';
					img.alt = 'ë¼ì´íŠ¸ ëª¨ë“œë¡œ ì „í™˜';
				} else {
					img.src = '/images/sidebar/darkmode.png';
					img.alt = 'ë‹¤í¬ ëª¨ë“œë¡œ ì „í™˜';
				}
			}

			// ì´ˆê¸° ìƒíƒœ: ì €ì¥ê°’ â†’ ì—†ìœ¼ë©´ OS ì„¤ì • ë”°ë¦„
			(function init() {
				const saved = localStorage.getItem(KEY);
				const preferDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
				const initial = saved || (preferDark ? 'dark' : 'light');
				applyTheme(initial);
			})();

			// ë²„íŠ¼ ì´ë²¤íŠ¸
			const btn = document.getElementById('lfThemeToggle');
			btn?.addEventListener('click', () => {
				const isDark = document.documentElement.classList.contains('theme-dark');
				applyTheme(isDark ? 'light' : 'dark');
			});
		})();


	</script>
	
	<script>
(function () {
  const addBalanceBtn = document.getElementById('addBalance');          // í˜ì´ì§€ ìƒë‹¨ ë²„íŠ¼
  const modal = document.getElementById('addBalanceModal');
  const form  = document.getElementById('addBalanceForm');
  const input = document.getElementById('addAmount');

  // í˜„ì¬ ì„ íƒëœ ì€í–‰ íƒ­ì˜ data-bank ì½ê¸° (ì—†ìœ¼ë©´ ì²« íƒ­)
  function getCurrentBank() {
    const selected = document.querySelector('.wallet-tabs .tab.selected[data-bank]');
    if (selected) return selected.dataset.bank;
    const first = document.querySelector('.wallet-tabs .tab[data-bank]');
    return first ? first.dataset.bank : null;
  }

  function openModal() {
    modal.hidden = false;
    document.body.style.overflow = 'hidden';
    setTimeout(() => input?.focus(), 0);
  }
  function closeModal() {
    modal.hidden = true;
    document.body.style.overflow = '';
    form.reset();
  }

  // ì—´ê¸°
  addBalanceBtn?.addEventListener('click', (e) => {
    e.preventDefault();
    const bank = getCurrentBank();
    if (!bank) return alert('ì€í–‰ íƒ­ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.');
    openModal();
  });

  // ë‹«ê¸° (ì˜¤ë²„ë ˆì´/ì·¨ì†Œ/X)
  modal?.addEventListener('click', (e) => {
    if (e.target.matches('[data-dismiss]')) closeModal();
  });
  document.addEventListener('keydown', (e) => {
    if (!modal.hidden && e.key === 'Escape') closeModal();
  });

  // ì œì¶œ
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const bankName = getCurrentBank();
    if (!bankName) return alert('ì€í–‰ íƒ­ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.');

    const amount = Number((new FormData(form)).get('amount') || 0);
    if (!Number.isFinite(amount) || amount <= 0) {
      input.focus(); return alert('1ì› ì´ìƒ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
    }
    const merchantUid = 'littleForest_wallet_addBalance' + Date.now();
	
	// ì¹´ì¹´ì˜¤í˜ì´ ê²°ì œì°½ í˜¸ì¶œ
	const IMP = window.IMP;
	try {IMP?.init?.('imp76384566');} catch (_) { }
	IMP.request_pay({
		pg: 'kakaopay',
		pay_method: 'card',
		merchant_uid: merchantUid,
		name: 'ê²°ì œí•˜ê¸°',
		amount: amount
	}, async (rsp) => {
		if (!rsp.success) {

			alert('ê²°ì œê°€ ì·¨ì†Œë˜ì—ˆê±°ë‚˜ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n' + (rsp.error_msg || ''));
			return;
		}
    try {
      const res = await fetch('/wallet/addBalance', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ bankName, amount })
      });
      if (!res.ok) {
        const msg = await res.text();
        throw new Error(msg || 'ì”ì•¡ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
      closeModal();
      // í•„ìš”í•˜ë©´ confetti ë“± íš¨ê³¼ ê°€ëŠ¥
      // shootConfetti?.();
      window.location.reload();
    } catch (err) {
      alert(err.message);
    }
  });
  });
})();
</script>


</body>

</html>