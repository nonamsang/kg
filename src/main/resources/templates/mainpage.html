<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Little Forest</title>
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<!-- í°íŠ¸ì–´ì¸ ì•„ì´ì½˜ ë¶ˆëŸ¬ì˜¤ëŠ” ì½”ë“œ -->
<link rel="stylesheet" href="/css/mainpagestyle.css">
<link rel="stylesheet" href="/css/userchat.css">
<link rel="stylesheet"
	href="https://jhammann.github.io/sakura/dist/sakura.css">
</head>

<body>
	<!-- í—¤ë” ì‚½ì… -->
	<div th:replace="fragments/header :: header"></div>

	<div class="sakura-container" id="sakura-petals">

		<a href="#" data-id="1" class="set-user">ì•„ì´ë””1ë¡œ</a>
		<a href="#" data-id="2" class="set-user">ì•„ì´ë””2ë¡œ</a> 
		<a href="#" data-id="3" class="set-user">ì•„ì´ë””3ë¡œ</a> 
		<a href="#" data-id="4" class="set-user">ì•„ì´ë””4ë¡œ</a>
		<a href="#" data-id="5" class="set-user">ì•„ì´ë””5ë¡œ</a>

		<div id="chat-root" th:attr="data-userid=${session.user_Id}"></div>

		<!-- ê³ ì •ëœ + ë²„íŠ¼ -->
		<div id="open-chat" aria-label="ì±„íŒ… ì—´ê¸°" role="button">+</div>

		<!-- ì±„íŒ… íŒ¨ë„: ì²˜ìŒì—” ìˆ¨ê¹€ + floating ëª¨ë“œ -->
		<div class="chat_area floating hide">
			<!-- ì²˜ìŒì—” ìˆ¨ê¹€ -->
			<div class="chat_container">
				<div id="msgs" class="chat_each_container">
					<!-- ê¸°ì¡´ íƒ€ì„ë¦¬í”„ ë Œë”/JS ë Œë” ì˜ì—­ -->
				</div>
			</div>

			<div class="chat-input">
				<input id="msg" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
				<button onclick="send()">ë³´ë‚´ê¸°</button>
			</div>

			<div id="chat-newchat" class="hide">ê´€ë¦¬ìì™€ ì±„íŒ… ì—°ê²°</div>
		</div>



	</div>

	<script th:inline="javascript">
		
	//set-user
		document.querySelectorAll('.set-user').forEach(link => { //forEach ë”ì— ìˆëŠ” ëª¨ë“  set-userì— ê´€í•´ ì´ ëª…ë ¹ì„ ìˆ˜í–‰
			link.addEventListener('click', function (e) { 
				e.preventDefault(); //í˜ì´ì§€ ë§¨ ìœ„ë¡œ ì í”„, í˜¹ì€ ë§í¬ë¡œ ì´ë™í•˜ë ¤ëŠ”ê±¸ ë§‰ê³  js ë¬¸ë²•ì„ ì™„ì „ ë¹„ë™ê¸°ë¡œ ì‹¤í–‰í•¨
				const userId = this.dataset.id; // ìœ„ì— ë‚´ê°€ ì¸ìë¡œ ì„¤ì •í•´ë‘” dataset.id ê°€ì ¸ì˜´
				
				console.log(/*[[${session.user_Id}]]*/); //session ê°’ ë³€ê²½ í›„ì—ëŠ” ìƒˆë¡œê³ ì¹¨ í•´ì•¼ ì ìš©ë¨
				
				const headers = {'Content-Type': 'application/x-www-form-urlencoded'}; 
				//id=5ì™€ ê°™ì€ í˜•ì‹ìœ¼ë¡œ ë³´ë‚¼ê±°ë¼ëŠ” ì˜ˆê³ ë¬¸, headers
	
				
				fetch('/set-user', {
					method: 'POST',
					headers, //id = 5 ê°™ì€ í˜•ì‹ìœ¼ë¡œ ë³´ë‚¸ë‹¤?
					body: `id=${userId}` //id = 5 ê°™ì€ í˜•ì‹ìœ¼ë¡œ ë³´ëƒ„
				})
				.then(res => res.json()) //jsonìœ¼ë¡œ íŒŒì‹±
				.then(data => { //íŒŒì‹±í•œ ê°’ì„ dataì— ë„£ìŒ
					console.log(`ì„¸ì…˜ ë³€ê²½ ì™„ë£Œ: ${data.status}, user id: ${data.user_Id}`); 
				});
			});
		}); //set-userë
		
		document.addEventListener('DOMContentLoaded', () => {
	    const chatArea  = document.querySelector('.chat_area');
	    const newChatEl = document.getElementById('chat-newchat');
	    const openBtn   = document.getElementById('open-chat');
	
		openBtn.addEventListener('click', onOpenChat);

	    async function onOpenChat() {
	      try {
	        // 1) ë‚´ ì±„íŒ…ë°© ê°œìˆ˜ í™•ì¸
	        const res = await fetch('/chat/user/chatroomcount');
	
	        // ìˆ«ì ì‘ë‹µì„ JSON í˜¹ì€ text ë‘˜ ë‹¤ ëŒ€ì‘
	        let count;
	       	count = await res.text();         // application/json ì´ë©´ ìˆ«ì
	       	console.log("count="+count);
	
	        if (Number(count) >= 1) {
	       		const panel   = document.querySelector('.chat_area.floating');
	       		const willOpen = panel.classList.contains('hide');
	       	    panel.classList.toggle('hide', !willOpen);
	       	    panel.classList.toggle('open', willOpen);
	
	          loadRoom().catch(console.error);
	          
	          
	        } else {
	        	
	          // ì±„íŒ…ë°© ì—†ìŒ â†’ ìƒˆ ì—°ê²° ì•ˆë‚´ UI ë…¸ì¶œ
	          const res = await fetch('/newchat', {
		          method: 'POST'
		        });
	        }
	      } catch (err) {
	        console.error(err);
	        alert('ì±„íŒ… ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”.');
	      }
	    }
	  });
	</script>
	<script th:inline="javascript">
  // ì „ì—­ ìƒíƒœ (ìƒëŒ€ ì •ë³´ & ë‚´ ì•„ì´ë””)
  let roomId;
  let MY_ID   = /*[[${session.user_Id}]]*/ 0; // í˜ì´ì§€ ìµœì´ˆ ì§„ì… ì‹œ ì„¸ì…˜ê°’
  let OTHER_NAME = 'ìƒëŒ€';
  let OTHER_PROFILE_URL = '/image/profile/default.png';

  const chatArea = document.querySelector('.chat_area');
  const msgs = document.getElementById('msgs');

  // 1) ë°© ì—´ê¸°: ì„œë²„ì—ì„œ JSON ê°€ì ¸ì˜¤ê³  ê·¸ë¦¬ê¸°
  async function loadRoom() {
	const getRoomId = await fetch(`/getchatroomid`)
	
	roomId = await getRoomId.text();
	
	connect();
	
    const res = await fetch(`/admin/chat/data?roomId=${roomId}`, {
      headers: { 'Accept': 'application/json' }
    });
    if (!res.ok) throw new Error('HTTP ' + res.status);

    const data = await res.json();

    MY_ID = data.myId;
    
    renderChat(data);
  }

  // 2) ë¦¬ìŠ¤íŠ¸ ì „ì²´ ë Œë” (ê¸°ì¡´ ì§€ìš°ê³  ë‹¤ì‹œ ê·¸ë¦¼)
  function renderChat(data) {
    OTHER_NAME = data?.otheruser?.other_User_Name || 'ìƒëŒ€';
    OTHER_PROFILE_URL = data?.otheruser?.other_User_Profile
      ? `/image/profile/${data.otheruser.other_User_Profile}`
      : '/image/profile/default.png';

    // ê¸°ì¡´ ë©”ì‹œì§€ ì‚­ì œ (ì„œë²„ ë Œë”ì™€ ê²¹ì¹˜ê²Œ ì‹«ìœ¼ë©´ ì´ ì¤„ ì£¼ì„ì²˜ë¦¬)
    msgs.innerHTML = '';

    (data.chat || []).forEach(m => appendMessage(m, MY_ID));
    
   

    // ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
    msgs.scrollTop = msgs.scrollHeight;
  }

  // 3) í•œ ì¤„ ì¶”ê°€ (ê³¼ê±° ë©”ì‹œì§€/ì›¹ì†Œì¼“ ìˆ˜ì‹  ê³µìš©)
  function appendMessage(m, myIdFromData = MY_ID) {
    const isMe = Number(m.sender) === Number(myIdFromData);

    const row = document.createElement('div');
    row.className = 'msg' + (isMe ? ' me' : '');

    if (!isMe) {
      const img = document.createElement('img');
      img.className = 'msg-profile';
      img.alt = 'profile';
      img.src = OTHER_PROFILE_URL;
      row.appendChild(img);
    }

    const body = document.createElement('div');
    body.className = 'msg-body';

    if (!isMe) {
      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = OTHER_NAME;
      body.appendChild(meta);
    }

    const bubble = document.createElement('div');
    bubble.className = 'msg-bubble';
    bubble.textContent = m.content ?? '';
    body.appendChild(bubble);

    row.appendChild(body);
    msgs.appendChild(row);
    msgs.scrollTop = msgs.scrollHeight;
  }

 
</script>

	<script>

let stomp, sub;
let reconnecting = false;

function connect() {
	console.log("ë£¸ì€ :" +roomId);
	const sock = new SockJS('/ws-chat');
	stomp = Stomp.over(sock);

	// â‘  STOMP ë””ë²„ê·¸ ì¶œë ¥: SEND/SUBSCRIBE/MESSAGE í”„ë ˆì„ì„ ì½˜ì†”ì— ë‹¤ ë³´ì—¬ì¤Œ
	stomp.debug = (str) => console.log('[STOMP]', str);

	stomp.connect({}, () => {
		console.log('âœ… STOMP connected?', stomp.connected);

		// â‘¡ êµ¬ë… ì„¤ì • (ì„œë²„ê°€ convertAndSend("/topic/rooms/"+roomId) ë¡œ ë³´ë‚´ëŠ”ì§€ ê¼­ í™•ì¸!)
		
		
		const dest = `/topic/rooms/${roomId}`;
		console.log('ğŸ”” SUBSCRIBE to', dest);
		if (sub) sub.unsubscribe();
		sub = stomp.subscribe(dest, (frame) => {
			console.log('ğŸ“¥ RECEIVED FRAME', frame);            // í—¤ë”/ë°”ë”” ë‹¤ ë³´ì„
			try {
				const m = JSON.parse(frame.body);
				console.log('ğŸ“© PARSED MSG', m);
				appendMessage(m);                                 // í™”ë©´ì— ì¶”ê°€
			} catch (e) {
				console.error('JSON parse error', e, frame.body);
			}
		});

	}, (err) => {
		console.error('âŒ STOMP connect error', err);
	});

	sock.onclose = scheduleReconnect;
}

function scheduleReconnect() {
	if (reconnecting) return;
	reconnecting = true;
	console.log('reconnect ì‹œë„ì¤‘');
	setTimeout(() => {reconnecting = false; connect();}, 3000);
}

function send() {
	const input = document.getElementById('msg');
	const text = input.value.trim();
	if (!text) return;

	if (!stomp || !stomp.connected) {
		return console.warn('âš ï¸ ì•„ì§ ì—°ê²° ì•ˆë¨. connect() ë¨¼ì € ì‹¤í–‰í•˜ì„¸ìš”.');
	}

	const payload = {
		type: 'SEND',
		chat_Room_Id: roomId,   // ì„œë²„ VO í•„ë“œëª…ê³¼ 100% ë™ì¼í•´ì•¼ í•¨
		sender: MY_ID,                  
		content: text
	};

	console.log('â¡ï¸ SEND payload', payload);
	stomp.send('/app/chat.send', {}, JSON.stringify(payload));
	input.value = '';
}
</script>

	<script
		src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>

	<script
		src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
	<!-- ë©”ì¸ ë°°ë„ˆ -->
	<section class="hero">


		<div class="hero-content">
			<h1>ë‚´ ì†ì•ˆì˜ ì‘ì€ ìˆ², LittleForest</h1>
			<p>
				íƒ„ì†Œë°°ì¶œëŸ‰ ì¸¡ì •,<br>ì§€ì†ê°€ëŠ¥í•œ ì†Œë¹„ ë¶„ì„,<br>ë‹¹ì‹ ì„ ìœ„í•œ í™˜ê²½ ë°ì´í„° í”Œë«í¼
			</p>
		</div>
	</section>

	<!-- ì»¨í…íŠ¸ ëª¨ìŒ -->

	<section class="scroll-section">
		<p class="scroll-text">SCROLL DOWN</p>
		<div class="scroll-line"></div>
		<h1>
			<span class="highlight">Litte Forest</span>ë¥¼ ê²½í—˜í•´ ë³´ì„¸ìš” !
		</h1>
	</section>

	<!-- í•˜ë‹¨ ë²„íŠ¼ -->
	<div class="service-title-wrapper">
		<h2 class="service-title">< Little Forestê°€ ì œê³µí•˜ëŠ” ì„œë¹„ìŠ¤ ></h2>
	</div>

	<div class="green-box">
		<div class="content">
			<div class="content-box">
				<img src="/image/maintree.png" alt="tree" /> <a
					th:href="@{/growtree}"><button>ë‚˜ë¬´í‚¤ìš°ëŸ¬ê°€ê¸°</button></a>
			</div>
			<div class="content-box">
				<img src="/image/paypal.png" alt="wallet" /> <a
					th:href="@{/wallet}"><button>ì§€ê°‘ìœ¼ë¡œê°€ê¸°</button></a>
			</div>
			<div class="content-box">
				<img src="/image/qrcode.png" alt="pay" /> <a th:href="@{/shop}"><button>ê²°ì œí•˜ëŸ¬ê°€ê¸°</button></a>
			</div>
			<div class="content-box">
				<img src="/image/co2-car.png" alt="emission" /> <a
					th:href="@{/emission}"><button>íƒ„ì†Œì†Œë¹„í™•ì¸</button></a>
			</div>
		</div>
	</div>

	<script>
			document.addEventListener("DOMContentLoaded", () => {
				const sections = document.querySelectorAll(".scroll-section2");

				// í™€ìˆ˜/ì§ìˆ˜ì— í´ë˜ìŠ¤ ë¶€ì—¬
				sections.forEach((section, index) => {
					if (index % 2 === 0) {
						section.classList.add("left");  // 0,2,4... ì™¼ìª½
					} else {
						section.classList.add("right"); // 1,3,5... ì˜¤ë¥¸ìª½
					}
				});

				// Intersection Observer
				const observer = new IntersectionObserver((entries) => {
					entries.forEach(entry => {
						if (entry.isIntersecting) {
							entry.target.classList.add("visible");
						}
					});
				}, {threshold: 0.2});

				sections.forEach(section => {
					observer.observe(section);
				});
			});
		</script>


	<!-- êµ¬ë¶„ì„  -->
	<div style="margin: 25px 0; border-top: 1px solid #ccc;"></div>

	<section class="scroll-section2">
		<p class="scroll-text">SCROLL DOWN</p>
		<div class="scroll-line"></div>
		<h1>
			í•˜ë£¨í•˜ë£¨ ìë¼ë‚˜ëŠ” <span class="highlight">ë‚˜ë§Œì˜ ë‚˜ë¬´</span>ë¥¼ ê¸¸ëŸ¬ë³´ì„¸ìš” !
		</h1>
		<div class="qrpay-wrapper">
			<img src="/image/growtree2.png" alt="growtree" />
			<p class="qrpay-desc">
				ì‘ì€ ì”¨ì•—ì—ì„œ ì‹œì‘í•´ ë¬¼ê³¼ ë¹„ë£Œë¥¼ ì£¼ë©° <br>í•˜ë£¨í•˜ë£¨ ë‚˜ë¬´ê°€ ìë¼ëŠ” ëª¨ìŠµì„ ì§€ì¼œë³´ì„¸ìš”!!! <br>ë¬¼ì„
				ëª¨ìœ¼ê³  ë¹„ë£Œë¡œ ì„±ì¥ ì†ë„ë¥¼ ë†’ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤ !!<br> ë‚˜ë¬´ë¥¼ ëª¨ë‘ í‚¤ìš°ë©´, ê²Œì„ ì† ë‚˜ë¬´ê°€ ì‹¤ì œ ì§€êµ¬ì— ì‹¬ì–´ì ¸
				í™˜ê²½ ë³´í˜¸ì— ê¸°ì—¬ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ !
			</p>
			<a href="/growtree" class="qrpay-btn">ë°”ë¡œê°€ê¸°</a>
		</div>
	</section>

	<section class="scroll-section2">
		<div class="scroll-line"></div>
		<h1>
			ì“°ê³  ì ë¦½í•˜ê³  <span class="highlight"> í™˜ê²½ì„ ì§€ì¼œë³´ì„¸ìš” !</span>
		</h1>
		<div class="qrpay-wrapper">
			<img src="/image/greenwallet.png" alt="greenwallet" />
			<p class="qrpay-desc">
				ë‚´ ì§€ê°‘ì´ ì§€êµ¬ë¥¼ ì›ƒê²Œ í•©ë‹ˆë‹¤.<br> ì†Œë¹„ ìŠµê´€ì„ í™•ì¸í•˜ê³ , ì ˆì•½í•œ ë§Œí¼ í™˜ê²½ì— ê¸°ë¶€í•˜ì„¸ìš” ! <br>
				LittleForest ì§€ê°‘ê³¼ í•¨ê»˜ë¼ë©´, <br>ë‚˜ë§Œì˜ ì‘ì€ ìˆ²ì„ ê°€ê¿€ ìˆ˜ ìˆìŠµë‹ˆë‹¤ ì‘ì€ í–‰ë™ì´ í° ë³€í™”ë¥¼ !
				ë§Œë“­ë‹ˆë‹¤.
			</p>
			<a href="/wallet" class="qrpay-btn">ë°”ë¡œê°€ê¸°</a>
		</div>
	</section>

	<section class="scroll-section2">
		<div class="scroll-line"></div>
		<h1>
			LittleForest ë§Œì˜ <span class="highlight"> GreenPay</span>ë¥¼ ì‚¬ìš©í•´ë³´ì„¸ìš” !
		</h1>
		<div class="qrpay-wrapper">
			<img src="/image/qrpay.jpg" alt="qrpay" />
			<p class="qrpay-desc">
				Little Forest ë§¤ì¥ì„ QRë¡œ ì—°ê²°í•©ë‹ˆë‹¤!<br> ê²°ì œ ì‹œ íƒ„ì†Œ ë°œìêµ­ ê³„ì‚°ì— ë”°ë¥¸ í¬ì¸íŠ¸ë¥¼ íšë“¤ í•  ìˆ˜
				ìˆì–´ìš” !<br> í–‰ìš´ì˜ ë„¤ìí´ë¡œë²„ QRë¡œ íƒ„ì†Œ ì ˆì•½ ì†Œë¹„ë¥¼ ì´í–‰í•´ ë³´ì•„ìš”! +ã…+
			</p>
			<a href="#" class="qrpay-btn">ë°”ë¡œê°€ê¸°</a>
		</div>
	</section>

	<section class="scroll-section2">
		<div class="scroll-line"></div>
		<h1>
			LittleForest ë§Œì˜ <span class="highlight"> GreenPay</span>ë¥¼ ì‚¬ìš©í•´ë³´ì„¸ìš” !
		</h1>
		<div class="qrpay-wrapper">
			<img src="/image/grape.png" alt="emission1" />
			<p class="qrpay-desc">
				ìŠ¤ìŠ¤ë¡œ ì‚¬ìš©í•œ íƒ„ì†ŒëŸ‰ì„ í•œëˆˆì— ê°„ë‹¨í•˜ê²Œ í™•ì¸í•´ ë³´ì„¸ìš” !<br> ì‚¬ìš©í•œ íƒ„ì†ŒëŸ‰ì„ í†µê³„ë¡œ í™•ì¸í•˜ì—¬ ì§€êµ¬ë¥¼ ì§€ì¼œ
				ë³´ì„¸ìš” !<br> í•œ ë‹¬ ë™ì•ˆ ì‚¬ìš©í•œ íƒ„ì†ŒëŸ‰, ì¼ ë…„ ë™ì•ˆ í™•ì¸í•œ íƒ„ì†ŒëŸ‰ì„ ì‰½ê²Œ í™•ì¸í•´ ë³´ì„¸ìš” !
			</p>
			<a href="/emission1" class="qrpay-btn">ë°”ë¡œê°€ê¸°</a>
		</div>
	</section>

	<!-- í‘¸í„° ì‚½ì… -->
	<div th:replace="fragments/footer :: footer"></div>


	<script src="https://jhammann.github.io/sakura/dist/sakura.js"></script>
	<script>
			var sakura = new Sakura('#sakura-petals', {
				fallSpeed: 5,
				maxSize: 23,
				minSize: 16,
				gradientColorStart: 'rgba(140, 190, 140, 1)',
				gradientColorEnd: 'rgba(140, 190, 140, 0.9)',
				lifeTime: 300
				//rgba(173, 223, 173, 0.8) ë¯¼íŠ¸
				//rgba(140, 190, 140, 0.8) ì˜¬ë¦¬ë¸Œ
				// Gradient color end (rgba).
			});
		</script>
</body>

</html>