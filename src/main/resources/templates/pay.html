<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">

<head>
	<meta charset="UTF-8">
	<title>κ²°μ λ‚΄μ—­ / ν¬μΈνΈ</title>

	<link rel="stylesheet" href="/css/donate-cta.css"> <!-- λ²„νΌ μ¤νƒ€μΌ -->
	<link rel="stylesheet" href="/css/pay.css"><!-- μ΄ νμ΄μ§€ μ „μ© -->
	<link rel="stylesheet" href="/css/donate.css"> <!-- κΈ°λ¶€ λ¨λ‹¬ μ¤νƒ€μΌ -->
	<link rel="stylesheet" href="/css/mainpagestyle.css">

	<!-- ν¬νΈμ›(Iamport) JS μΉ΄μΉ΄μ¤νμ΄ κ²°μ μ°½ νΈμ¶μ© -->
	<script src="https://cdn.iamport.kr/v1/iamport.js"></script>
</head>

<body>

	<!-- β¬‡οΈ confetti λΌμ΄λΈλ¬λ¦¬ λ΅λ“ -->
	<script src="/js/confetti.min.js"></script>

	<!-- κ³µν†µ header -->
	<div th:replace="fragments/header :: header"></div>

	<div class="pay-page">
		<!-- νƒ­ -->
		<div class="pay-tabs">
			<a th:classappend="${tab}=='history' ? ' active'" th:href="@{/pay(tab='pointlist')}">ν¬μΈνΈλ‚΄μ—­</a>
			<a th:classappend="${tab}=='points' ? ' active'" th:href="@{/pay(tab='points')}">μ΄λ²¤νΈ</a>
		</div>

		<div class="pay-grid">
			<!-- μ™Όμ½ -->
			<main class="pay-main">
				<!-- ============ ν¬μΈνΈλ‚΄μ—­ νƒ­ ============ -->
				<section th:if="${tab}=='pointlist'">
					<h2 class="section-title">ν¬μΈνΈλ‚΄μ—­</h2>

					<!-- λ°μ΄ν„° μ—†μ„ λ• -->
					<div class="empty" th:if="${#lists.isEmpty(pointList)}">κ²°μ  λ‚΄μ—­μ΄ μ—†μ–΄μ”.</div>

					<!-- ν¬μΈνΈ λ¦¬μ¤νΈ -->
					<ul class="history-list" th:if="${!#lists.isEmpty(pointList)}">
						<li class="history-card" th:each="point : ${pointList}">
							<div class="hc-left">
								<div class="hc-title" th:text="${point.memo}">λ©”λ¨/μ½”λ“</div>
								<div class="hc-meta">
									<span th:text="${point.type}">deposit</span>
									<span>Β·</span>
									<span th:text="${#dates.format(point.created_At, 'yyyy.MM.dd')}">2025.01.01</span>
								</div>
							</div>
							<div class="hc-right">
								<!-- κΈμ•΅: + / - ν‘κΈ° -->
								<div class="hc-amount" th:text="${(point.amount >= 0 ? '+' : '-') 
                         + #numbers.formatInteger(T(java.lang.Math).abs(point.amount), 3, 'COMMA')} + 'ν¬μΈνΈ'">
									+1,000ν¬μΈνΈ
								</div>
							</div>
						</li>
					</ul>
				</section>

				<!-- ============ ν¬μΈνΈ νƒ­ ============ -->
				<section th:if="${tab}=='points'">
					<h2 class="section-title">ν¬μΈνΈ μ‰½κ² λ°›κΈ°</h2>

					<!-- μƒλ‹¨ μΉ΄λ“ 3κ° (λ²„νΌλ§ λ™μ‘. κ΄‘κ³  μ—°λ™μ€ μ¶”ν›„) -->
					<div class="easy-cards">
						<div class="easy-card">
							<div class="ec-badge">μ΄λ²¤νΈ</div>
							<div class="ec-title">μλ™μ°¨λ³΄ν— ν™•μΈν•λ©΄</div>
							<div class="ec-amount">7μ²μ›</div>
							<button type="button" class="btn-outline" disabled>ννƒλ³΄κΈ°</button>
						</div>

						<div class="easy-card">
							<div class="ec-badge">μ΄λ²¤νΈ</div>
							<div class="ec-title">μ „κ³ κ° μµμ† 2λ§μ› μΏ ν°</div>
							<div class="ec-amount">2λ§μ›+</div>
							<button type="button" class="btn-outline" disabled>ννƒλ³΄κΈ°</button>
						</div>

						<div class="easy-card">
							<div class="ec-badge">μ΄λ²¤νΈ</div>
							<div class="ec-title">λ¬΄λ£ μ§€μ› μ΄λ²¤νΈ</div>
							<div class="ec-amount">33P</div>
							<button type="button" class="btn-outline" disabled>ννƒλ³΄κΈ°</button>
						</div>
					</div>

					<!-- μ¤λμ μƒν™μ‹¤μ²ν -->
					<h3 class="section-sub"> ν΄λ¦­ν•λ©΄ λ°”λ΅ μ λ¦½</h3>
					<ul class="event-list">
						<!-- ν΄λ¦­ μ¦‰μ‹ ν¬μΈνΈ μ λ¦½: μ„λ²„μ— POST -->
						<li class="event-row">
							<div>
								<div class="ev-title">μ¤λμ μƒν™μ‹¤μ²ν λ³΄κ³ </div>
								<div class="ev-meta">15P λ°›κΈ°</div>
							</div>
							<button type="button" class="btn-green" onclick="openTipModal()">ν¬μΈνΈ λ°›κΈ°</button>
						</li>
						<!-- κ·Έλ¦°μ»¤λ®¤λ‹ν‹° λ°©λ¬Έ -->
						<li class="event-row">
							<div>
								<div class="ev-title">κ·Έλ¦°μ»¤λ®¤λ‹ν‹° λ°©λ¬Έν•κ³ </div>
								<div class="ev-meta">5P λ°›κΈ°</div>
							</div>
							<!-- code λΌλ” μ΄λ¦„μΌλ΅ λ³΄λƒ„ -->
							<button type="button" class="btn-green"
								onclick="claimAndGo('COMMUNITY', 5, 'μ»¤λ®¤λ‹ν‹° λ°©λ¬Έ', '/community')">
								ν¬μΈνΈ λ°›κΈ°
							</button>
						</li>
						<!-- ν„μ¥κ²°μ  μ¶”κ°€ μ λ¦½ -->
						<li class="event-row">
							<div>
								<div class="ev-title">ν„μ¥κ²°μ ν•κ³ </div>
								<div class="ev-meta">μ¶”κ°€ ν¬μΈνΈ λ°›κΈ°</div>
							</div>
							<button type="button" class="btn-green"
								onclick="claimDaily('OFFLINE_BONUS', 30, 'ν„μ¥κ²°μ  μ¶”κ°€μ λ¦½')">
								ν¬μΈνΈ λ°›κΈ°
							</button>
						</li>
					</ul>
				</section>
			</main>

			<!-- μ¤λ¥Έμ½ μ‚¬μ΄λ“: μ μ € μΉ΄λ“(ν•­μƒ λ™μΌ) -->
			<aside class="pay-side">
				<div class="user-card">
					<div class="uc-header">
						<div class="uc-name" th:text="${userInfo.name}">μ΄λ¦„</div>
						<a href="/mypage" class="uc-settings">λ§μ΄νμ΄μ§€</a>
					</div>

					<div class="balance-cards">
						<div class="balance-card">
							<div class="bc-title">LF ν¬μΈνΈ</div>
							<div class="bc-amount" id="pointBalance"
								th:text="${#numbers.formatInteger(userInfo.point, 3, 'COMMA')} + 'ν¬μΈνΈ'">0ν¬μΈνΈ</div>
							<div class="bc-actions">
								<button type="button" class="btn-light" id="btnCharge">μ¶©μ „</button>
								<button type="button" class="btn-light" id="btnGiftOpen">ν¬μΈνΈ μ„ λ¬Ό</button>
								<button type="button" class="btn-light" disabled>μ†΅κΈ</button>
							</div>
						</div>
					</div>
					<!-- =======κΈ°λ¶€ν•κΈ° λ²„νΌ ======= -->
					<div class="donate-cta-wrap">
						<button type="button" id="openDonateModalPay" class="donate-cta btn-jittery"
							aria-label="κΈ°λ¶€ λ¨λ‹¬ μ—΄κΈ°">κΈ°λ¶€ν•κΈ°</button>
					</div>
				</div>
			</aside>
		</div>
	</div>

	<!-- κΈ°λ¶€ μ„±κ³µ μ „μ© λ¨λ‹¬ (λ‹¤λ¥Έ λ¨λ‹¬κ³Ό λ¶„λ¦¬) -->
	<div id="donateSuccessModal" class="lf-success" aria-hidden="true">
		<div class="lf-success__backdrop" data-close></div>
		<div class="lf-success__dialog" role="dialog" aria-modal="true" aria-labelledby="donateSuccessTitle">
			<h3 id="donateSuccessTitle" class="lf-success__title">κΈ°λ¶€κ°€ μ™„λ£λμ—μµλ‹λ‹¤</h3>
			<p class="lf-success__msg">λ”°λ»ν• λ§μμ— κ°μ‚¬λ“λ¦½λ‹λ‹¤! μ‘μ€ μ²μ΄ μλΌκ³  μμ–΄μ” π±</p>
			<div class="lf-success__actions">
				<button type="button" class="btn-green" data-close>ν™•μΈ</button>
			</div>
		</div>
	</div>

	<!-- μ¶©μ „ λ¨λ‹¬ -->
	<div id="chargeModal" class="donate-modal" aria-hidden="true" style="display:none">
		<div class="donate-dialog" role="dialog" aria-modal="true" aria-labelledby="chargeTitle">
			<div class="donate-header">
				<div class="donate-tabs">
					<button class="donate-tab active">μΉ΄μΉ΄μ¤νμ΄ μ¶©μ „</button>
				</div>
				<button type="button" class="donate-close" id="closeChargeModal" aria-label="λ‹«κΈ°">Γ—</button>
			</div>

			<div class="donate-body">
				<h2 id="chargeTitle" class="donate-quote">
					β€ν¬μΈνΈ μ¶©μ „, λ” λ§μ€ ννƒμ΄ μ‹μ‘λ©λ‹λ‹¤.β€
				</h2>
				<p class="donate-sub">κ²°μ  μ„±κ³µ μ‹ ν¬μΈνΈκ°€ μ¦‰μ‹ μ λ¦½λ©λ‹λ‹¤.</p>

				<div class="donate-grid">
					<!-- κΈμ•΅ μ…λ ¥ μμ—­ -->
					<div class="donate-left">
						<div class="amount-row">
							<label for="chargeAmount">μ¶©μ „ν•  κΈμ•΅</label>
							<div class="amount-input-wrap">
								<input id="chargeAmount" type="number" inputmode="numeric" min="1000" step="100"
									placeholder="κΈμ•΅μ„ μ…λ ¥ν•μ„Έμ”(μ›)" aria-describedby="chargeAmountHelp">
								<span class="unit">μ›</span>
							</div>
							<div id="chargeAmountHelp" class="help">οΌκΈμ•΅μ„ μ…λ ¥ν• ν›„ <b>μ¶©μ „ν•κΈ°</b>λ¥Ό λλ¬μ£Όμ„Έμ”.</div>

							<div class="quick-buttons">
								<!-- ν•„μ”μ— λ”°λΌ κΈμ•΅ μμ •(μ: 5μ²/1λ§/2λ§/3λ§) -->
								<button type="button" data-amt="5000">5μ²μ›</button>
								<button type="button" data-amt="10000">1λ§μ›</button>
								<button type="button" data-amt="20000">2λ§μ›</button>
								<button type="button" data-amt="30000">3λ§μ›</button>
							</div>
						</div>

						<div class="method-row">
							<span class="method-label">κ²°μ  μλ‹¨</span>
							<div class="method-pill">μΉ΄μΉ΄μ¤νμ΄</div>
						</div>
					</div>

					<!-- μ•λ‚΄/ν™•μΈ + μ μ¶ -->
					<aside class="donate-right">

						<div class="org-box">
							<label class="checkbox">
								<input type="checkbox" id="agreeCharge" checked>
								<span>κ²°μ μ΅°κ±΄ ν™•μΈ λ° κ°μΈμ •λ³΄ μ κ³µμ— λ™μν•©λ‹λ‹¤.</span>
							</label>
						</div>

						<button type="button" id="btnChargeConfirm" class="donate-btn donate-btn--wave">
							<span class="wave" aria-hidden="true"></span>
							<span class="label">μ¶©μ „ν•κΈ°</span>
						</button>
					</aside>
				</div>
			</div>
		</div>
	</div>

	<!-- μ„ λ¬Ό λ¨λ‹¬ -->
	<div id="giftModal" class="modal" aria-hidden="true">
		<div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="giftTitle">
			<div class="modal-header">
				<h3 id="giftTitle">ν¬μΈνΈ μ„ λ¬Όν•κΈ°</h3>
				<button type="button" class="modal-close" id="giftClose">Γ—</button>
			</div>
			<div class="modal-body">
				<div class="form-row">
					<label>λ°›λ” μ‚¬λ μ•„μ΄λ””</label>
					<input type="number" id="giftTo" min=1 placeholder="μ) 2">
				</div>
				<div class="form-row">
					<label>λ³΄λ‚Ό ν¬μΈνΈ(μ›)</label>
					<input type="number" id="giftAmount" min="500" step="100" placeholder="500">
				</div>
				<div class="form-row">
					<label>λ©”λ¨(μ„ νƒ)</label>
					<input type="text" id="giftMemo" maxlength="50">
				</div>
				<button type="button" class="btn-green" id="btnGiftSubmit">λ³΄λ‚΄κΈ°</button>
			</div>
		</div>
	</div>

	<!-- μ¤λμ μƒν™μ‹¤μ²ν λ¨λ‹¬ -->
	<div id="tipModal" class="modal" aria-hidden="true">
		<div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="tipTitle">
			<div class="modal-header">
				<h3 id="tipTitle">μ¤λμ μƒν™μ‹¤μ²ν</h3>
				<button type="button" class="modal-close" id="tipClose">Γ—</button>
			</div>
			<div class="modal-body">
				<p id="tipText" style="line-height:1.6; margin-bottom:16px;">
					<!-- μλ°”μ¤ν¬λ¦½νΈλ΅ μ¤λμ νμ΄ λ“¤μ–΄μµλ‹λ‹¤ -->
				</p>
				<button type="button" class="btn-green" id="btnTipGet">μ΄ νμΌλ΅ 15P λ°›κΈ°</button>
			</div>
		</div>
	</div>

	<!-- <div th:replace="fragments/donateModal :: donateModal"></div> -->
	<div th:replace="~{fragments/donateModal :: donateModal(pointBalance=${userInfo.point})}"></div>

	<!-- κ³µν†µ footer -->
	<div th:replace="fragments/footer :: footer"></div>

	<script th:inline="javascript">

		const MERCHANT_CODE = /*[[${merchantCode}]]*/ '';
		const LOGIN_USER_ID = /*[[${userInfo.id}]]*/ null;
		/*
		  const MERCHANT_CODE = '[[${merchantCode}]]'; // application.ymlμ—μ„ μ£Όμ…
		  const LOGIN_USER_ID = [[${userInfo.id}]];    // ν„μ¬ λ΅κ·ΈμΈ(μ„μ‹ testUserId) 
		*/

		/* ν¬νΈμ› μ΄κΈ°ν™” + ν¬μΈνΈ μ λ¦½/μ„ λ¬Ό/μ¶©μ „ λ¨λ‹¬ μ μ–΄ */

		// μ¤λμ ν λ©λ΅ (μ›ν•λ” λ§νΌ μ¶”κ°€ κ°€λ¥)
		const DAILY_TIPS = [
			'ν”λΌμ¤ν‹± λΉ¨λ€ λ€μ‹  ν…€λΈ”λ¬ λκ»‘μ„ μ‚¬μ©ν•΄μ”.',
			'μ„Ένƒμ€ λ¨μ•„μ„ β€λƒ‰μΒ·μ μ „ μ½”μ¤β€λ΅ λλ ¤μ”.',
			'μ—λ¦¬λ² μ΄ν„° ν• λ² λ€μ‹  κ³„λ‹¨ ν• μΈµ μ¤λ¥΄κΈ°!',
			'μ–‘μΉν•  λ• μ»µ μ‚¬μ©μΌλ΅ λ¬Ό μ μ•½ν•κΈ°.',
			'μ¥ λ³΄λ¬ κ° λ• μ¥λ°”κµ¬λ‹ ν•„μ!',
			'λ€μ¤‘κµν†µ/λ„λ³΄λ΅ μ΄λ™ κ±°λ¦¬λ¥Ό ν• λ² λ°”κΏ”λ³΄κΈ°.',
			'μ½μ„ΌνΈ λ€κΈ°μ „λ ¥ λ©€ν‹°νƒ­μΌλ΅ ν•λ²μ— OFF.',
			'μƒ¤μ› μ‹κ°„μ„ 1λ¶„λ§ μ¤„μ—¬λ„ ν° μ μ•½!',
			'μ „μμμμ¦ μ„¤μ •μΌλ΅ μΆ…μ΄ μμμ¦ μ¤„μ΄κΈ°.',
			'λ°°λ‹¬ μΌνμ©ν’ β€μμ €Β·μ “κ°€λ½ λ°›μ§€ μ•κΈ°β€ μ²΄ν¬.',
			'λ¶ν•„μ”ν• μ΄λ©”μΌ κµ¬λ… ν•΄μ§€(μ„λ²„ μ „λ ¥β†“).',
			'μ“°λ κΈ° λ¶„λ¦¬μκ±°, λΌλ²¨/μ΄λ¬Όμ§ μ κ±°κΉμ§€!',
			'μ¬ν™μ© κ°€λ¥ν• μ λ¦¬Β·μΊ”μ€ κΌ­ λ¶„λ¦¬ λ°°μ¶.',
			'λƒ‰μ¥κ³  λ¬Έ μ—¬λ‹«λ” νμ μ¤„μ΄κΈ°.',
			'μ¶©μ „ 100% ν›„ μ¶©μ „κΈ° λ½‘μ•„ λ€κΈ°μ „λ ¥ μ¤„μ΄κΈ°.',
			'μΆ…μ΄ λ€μ‹  λ©”λ¨ μ•±/ν΄λΌμ°λ“ μ‚¬μ©ν•΄λ³΄κΈ°.',
			'κ°€κΉμ΄ κ±°λ¦¬λ” μμ „κ±°! κ±΄κ°•λ„ UP.',
			'νƒλ°° λ°•μ¤λ” ν…μ΄ν”„ μ κ±° ν›„ μ ‘μ–΄μ„ λ°°μ¶.',
			'μλ¥ κΈ°λ¶€/λ¦¬μ‚¬μ΄ν΄ μκ±°ν•¨ ν™μ©ν•κΈ°.',
			'λ²„λ¦¬λ” μμ‹ μ¤„μ΄κΈ°: μ†λ¶„Β·λ°€ν”„rep μ‹λ„!'
		];
		// ============================μ΄λ²¤νΈκ΄€λ ¨=======================================
		//μ¤λ λ‚ μ§λ΅ ν μ„ νƒ
		function pickDailyTip() {
			const now = new Date();
			const start = new Date(now.getFullYear(), 0, 0);
			const dayOfYear = Math.floor((now - start) / 86400000);
			return DAILY_TIPS[dayOfYear % DAILY_TIPS.length];
		}

		// λ¨λ‹¬ μ—΄κΈ°/λ‹«κΈ°
		const tipModal = document.getElementById('tipModal');
		const tipClose = document.getElementById('tipClose');
		const tipTextEl = document.getElementById('tipText');
		const btnTipGet = document.getElementById('btnTipGet');

		function openTipModal() {
			tipTextEl.textContent = pickDailyTip();
			tipModal.classList.add('show');
		}

		tipClose?.addEventListener('click', () => tipModal.classList.remove('show'));
		tipModal?.addEventListener('click', (e) => {if (e.target === tipModal) tipModal.classList.remove('show');});

		// β€μ΄ νμΌλ΅ 15P λ°›κΈ°β€ (ν•λ£¨ 1ν μ ν•)
		btnTipGet?.addEventListener('click', async () => {
			await claimDaily('DAILY_TIP', 15, 'μ¤λμ μƒν™μ‹¤μ²ν');
			tipModal.classList.remove('show');
		});

		(function () {
			// ================================== μ„ λ¬Ό λ¨λ‹¬ =====================================
			const modal = document.getElementById('giftModal');
			const openBtn = document.getElementById('btnGiftOpen');
			const closeBtn = document.getElementById('giftClose');
			const submitBtn = document.getElementById('btnGiftSubmit');

			openBtn?.addEventListener('click', () => modal.classList.add('show'));
			closeBtn?.addEventListener('click', () => modal.classList.remove('show'));
			modal?.addEventListener('click', (e) => {if (e.target === modal) modal.classList.remove('show');});

			submitBtn?.addEventListener('click', async () => {
				const to = Number(document.getElementById('giftTo').value || 0);
				const amount = Number(document.getElementById('giftAmount').value || 0);
				const memo = document.getElementById('giftMemo').value || '';

				if (!to || amount < 1) {alert('user_idμ™€ λ³΄λ‚Ό κΈμ•΅μ„ ν™•μΈν•΄ μ£Όμ„Έμ”.'); return;}

				try {
					const res = await fetch('/points/gift', {
						method: 'POST',
						headers: {'Content-Type': 'application/x-www-form-urlencoded'},
						body: new URLSearchParams({to_user_id: to, amount, memo})
					});
					const text = await res.text();
					if (!res.ok) throw new Error(text || 'μ„ λ¬Ό μ‹¤ν¨');

					// μ„±κ³µ μ‹ λ‚΄ ν¬μΈνΈ ν‘μ‹ κ°±μ‹ 
					const cur = document.getElementById('pointBalance');
					const newVal = Number(text); // μ„λ²„μ—μ„ μƒ μ”μ•΅μ„ μ«μλ΅ λ°ν™
					cur.textContent = newVal.toLocaleString() + 'ν¬μΈνΈ';
					alert('ν¬μΈνΈλ¥Ό μ„ λ¬Όν–μµλ‹λ‹¤!');
					modal.classList.remove('show');
				} catch (e) {
					alert(e.message);
				}
			});

			//=========================== μ¦‰μ‹ μ λ¦½(μ΄λ²¤νΈ) ==========================
			// ν•λ£¨ 1ν μ λ¦½ νΈμ¶ (μ„λ²„ 409 λλ” λ¬Έμμ—΄ μ‘λ‹µ λ¨λ‘ μ²λ¦¬)
			async function claimDaily(code, amount, memo) {
				try {
					const res = await fetch('/points/event/daily', {
						method: 'POST',
						headers: {'Content-Type': 'application/x-www-form-urlencoded'},
						body: new URLSearchParams({
							code,                          // νλΌλ―Έν„° μ΄λ¦„μ€ code
							...(amount ? {amount} : {}), // μ„λ²„κ°€ κΈ°λ³Έκ°’ μ£Όλ©΄ μƒλµ κ°€λ¥
							memo: memo || ''
						})
					});

					const text = await res.text();

					// μ΄λ―Έ μλ Ήν• κ²½μ°: 409 (κ¶μ¥) λλ” λ¬Έμμ—΄ μ‘λ‹µλ„ λ€λΉ„
					if (res.status === 409 || text === 'ALREADY_CLAIMED' || text === 'ALREADY_TODAY') {
						alert('μ¤λμ€ μ΄λ―Έ λ°›μ•μµλ‹λ‹¤!');
						return;
					}
					if (!res.ok) {
						alert(text || 'μ λ¦½ μ‹¤ν¨');
						return;
					}

					const newBal = Number(text);
					const el = document.getElementById('pointBalance');
					if (el) el.textContent = newBal.toLocaleString() + 'ν¬μΈνΈ';

					try {confetti && confetti();} catch (_) { }
					alert('μ λ¦½ μ™„λ£!');
				} catch (e) {
					alert(e.message || 'μ λ¦½ μ‹¤ν¨');
				}
			}

			// λ°©λ¬Έν•λ©΄μ„ μ λ¦½(ν•λ£¨ 1ν) + μ΄λ™
			function claimAndGo(code, amount, memo, url) {
				const params = new URLSearchParams({
					code,
					...(amount ? {amount} : {}),
					memo: memo || ''
				});

				if (navigator.sendBeacon) {
					const blob = new Blob([params], {type: 'application/x-www-form-urlencoded;charset=UTF-8'});
					navigator.sendBeacon('/points/event/daily', blob);
					window.location.href = url;
				} else {
					fetch('/points/event/daily', {
						method: 'POST',
						headers: {'Content-Type': 'application/x-www-form-urlencoded'},
						body: params,
						keepalive: true
					}).finally(() => window.location.href = url);
				}
			}

			// μ „μ—­ λ…Έμ¶ (onclickμ—μ„ μ“Έ μ μκ²)
			window.claimDaily = claimDaily;
			window.claimAndGo = claimAndGo;


			// ============ ν¬νΈμ›(μΉ΄μΉ΄μ¤νμ΄) μ¶©μ „ ============
			// μ„λ²„μ—μ„ Thymeleafλ΅ MERCHANT_CODE λ„κ²¨μ¤
			(function () {
				const MIN_CHARGE = 1000; // ν•„μ” μ‹ 5000μΌλ΅ λ³€κ²½

				// λ¨λ‹¬ μ—λ¦¬λ¨ΌνΈ
				const modal = document.getElementById('chargeModal');
				const openBtn = document.getElementById('btnCharge');          // μ°μΈ΅ μΉ΄λ“μ "μ¶©μ „" λ²„νΌ
				const closeBtn = document.getElementById('closeChargeModal');
				const confirmBtn = document.getElementById('btnChargeConfirm');
				const amountInput = document.getElementById('chargeAmount');

				// μ—΄κΈ°/λ‹«κΈ°
				openBtn?.addEventListener('click', () => {
					modal.style.display = 'block';
					modal.setAttribute('aria-hidden', 'false');
					amountInput.focus();
				});
				const closeModal = () => {
					modal.style.display = 'none';
					modal.setAttribute('aria-hidden', 'true');
					amountInput.value = '';
				};
				closeBtn?.addEventListener('click', closeModal);
				modal?.addEventListener('click', (e) => {if (e.target === modal) closeModal();});
				document.addEventListener('keydown', (e) => {if (e.key === 'Escape' && modal.style.display === 'block') closeModal();});

				// λΉ λ¥Έ κΈμ•΅ λ²„νΌ
				document.querySelectorAll('#chargeModal .quick-buttons button').forEach(b => {
					b.addEventListener('click', () => amountInput.value = b.dataset.amt);
				});

				// μ¶©μ „ν•κΈ° β†’ μΉ΄μΉ΄μ¤νμ΄ κ²°μ μ°½
				confirmBtn?.addEventListener('click', async () => {
					const amount = parseInt(amountInput.value || '0', 10);
					if (Number.isNaN(amount) || amount < MIN_CHARGE) {
						alert(`${MIN_CHARGE.toLocaleString()}ν¬μΈνΈ μ΄μƒλ¶€ν„° μ¶©μ „ν•  μ μμµλ‹λ‹¤.`);
						amountInput.focus();
						return;
					}
					if (!document.getElementById('agreeCharge').checked) {
						alert('κ²°μ μ— λ™μν•΄ μ£Όμ„Έμ”.');
						return;
					}

					const merchantUid = 'point_charge_' + Date.now();

					// μΉ΄μΉ΄μ¤νμ΄ κ²°μ μ°½ νΈμ¶
					const IMP = window.IMP;
					try {IMP?.init?.(MERCHANT_CODE);} catch (_) { }
					IMP.request_pay({
						pg: 'kakaopay',
						pay_method: 'card',
						merchant_uid: merchantUid,
						name: 'ν¬μΈνΈ μ¶©μ „',
						amount: amount
					}, async (rsp) => {
						if (!rsp.success) {
							alert('κ²°μ κ°€ μ·¨μ†λμ—κ±°λ‚ μ‹¤ν¨ν–μµλ‹λ‹¤.\n' + (rsp.error_msg || ''));
							return;
						}

						try {
							// μ„λ²„ κ²€μ¦ + DB μ λ¦½
							const res = await fetch('/points/charge/complete', {
								method: 'POST',
								headers: {'Content-Type': 'application/x-www-form-urlencoded'},
								body: new URLSearchParams({
									imp_uid: rsp.imp_uid,
									merchant_uid: rsp.merchant_uid,
									amount: String(amount)
								})
							});

							const text = await res.text();
							if (!res.ok) throw new Error(text || 'μ¶©μ „ μ‹¤ν¨');

							// μ”μ•΅ κ°±μ‹ 
							const newBalance = Number(text);
							const balEl = document.getElementById('pointBalance');
							if (balEl) balEl.textContent = newBalance.toLocaleString() + 'μ›';

							closeModal();
							alert('μ¶©μ „μ΄ μ™„λ£λμ—μµλ‹λ‹¤!');
						} catch (e) {
							alert(e.message);
						}
					});
				});
			})();
		})();


		/* κΈ°λ¶€ μ„±κ³µ λ¨λ‹¬ μ—΄κΈ°/λ‹«κΈ° + μ½νν‹° μ¦‰μ‹ μ‹¤ν–‰ */
		(function () {
			const modal = document.getElementById('donateSuccessModal');
			const closeEls = modal.querySelectorAll('[data-close]');
			let confettiTimer;

			function showDonateSuccess() {
				// λ¨λ‹¬ ν‘μ‹ + λ°°κ²½ μ–΄λ‘΅κ²(μ΄ λ¨λ‹¬μ—λ§ μ μ©)
				modal.classList.add('show');
				modal.setAttribute('aria-hidden', 'false');

				// μ½νν‹° μ¦‰μ‹ λ°μ‚¬ (μ¤‘μ•™μ—μ„ λ°λ³µ λ°μ‚¬)
				/*
				try { shootConfetti(); } catch(_) {}
				// 1~1.5μ΄ κ°€λ³κ² μ¶”κ°€ λ°μ‚¬(μ—¬λ¬λ² λ§μ΄ λ°μ‚¬)
				let count = 0;
				confettiTimer = setInterval(() => {
				  //try { if (typeof confetti === 'function') confetti(); } catch(_) {}
				  try { shootConfetti(); } catch(_) {}
				  if (++count > 10) clearInterval(confettiTimer);
				}, 120);
			 */
				//μ¤‘μ•™λ§κ³  λ¨λ‹¬μ£Όλ³€ μ—¬λ¬κµ°λ° λ°μ‚¬ 

				try {
					// ν¨κ³Όλ¥Ό λ” λ¶€λ“λ½κ² λ³΄μ΄λ„λ΅ μ–‘/μ„ΈκΈ°λ¥Ό μ κΉ λ‚®μ¶°λ„
					confetti.setCount(40);
					confetti.setPower(20);
					scatterConfettiAroundModal('.lf-success__dialog', 8); // 8κ³³
					setTimeout(() => scatterConfettiAroundModal('.lf-success__dialog', 5), 150); // μ‚΄μ§ ν• λ² λ”
				} catch (_) { }

				requestAnimationFrame(forceConfettiBehind);
			}


			// (λ³€κ²½) ν• λ²λ§, λλ” 2ν κ°€λ³κ²
			//try { shootConfetti(); } catch(_) {}
			//confettiTimer = setTimeout(() => { try { shootConfetti(); } catch(_) {} }, 250); // 2λ²μ§Έ κ°€λ³κ²
			//}

			function hideDonateSuccess() {
				modal.classList.remove('show');
				modal.setAttribute('aria-hidden', 'true');
				clearInterval(confettiTimer);
			}

			// λ°°κ²½ ν΄λ¦­/ν™•μΈ λ²„νΌμΌλ΅ λ‹«κΈ°
			modal.addEventListener('click', (e) => {if (e.target.matches('[data-close]')) hideDonateSuccess();});
			closeEls.forEach(btn => btn.addEventListener('click', hideDonateSuccess));

			// μ „μ—­μ—μ„ νΈμ¶ν•  μ μλ„λ΅ λ…Έμ¶
			window.showDonateSuccess = showDonateSuccess;
			window.hideDonateSuccess = hideDonateSuccess;
		})();

		/*
		IMP.request_pay λ΅ μΉ΄μΉ΄μ¤νμ΄ κ²°μ μ°½μ„ λ„μ›€ β†’ μ„±κ³µ μ‹ μ„λ²„(/points/charge/complete)λ΅ imp_uid λ“± μ „λ‹¬ 
		β†’ μ„λ²„κ°€ ν¬νΈμ› REST APIλ΅ κ²°μ κ²€μ¦ ν›„ user_table.point μ¦κ°€.
		β€ν¬μΈνΈ μ„ λ¬Όβ€μ€ κ°„λ‹¨ λ¨λ‹¬λ΅ λ°›λ” μ‚¬λ user_idμ™€ κΈμ•΅λ§ λ°›κ³  μ„λ²„(/points/gift)μ—μ„ λ³΄λ‚΄λ” μ‚¬λ μ°¨κ° 
		+ λ°›λ” μ‚¬λ μ¦κ°€λ¥Ό νΈλμ­μ…μΌλ΅ μ²λ¦¬.
		β€ν¬μΈνΈ λ°›κΈ°(μ΄λ²¤νΈ)β€λ” API /points/eventλ΅ POST β†’ ν¬μΈνΈ μ¶”κ°€.
		 */


	</script>
</body>

</html>